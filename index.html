<!DOCTYPE html>

<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Espresso">
<meta name="theme-color" content="#F2F0EB">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>Espresso Tracker</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*, *::before, *::after {
  margin: 0; padding: 0; box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
  -webkit-touch-callout: none;
}
button, a, label, [role="button"] {
  touch-action: manipulation;
}
button, input, select, textarea {
  -webkit-appearance: none;
  appearance: none;
  font-family: inherit;
}
:root {
  --bg: #F2F0EB;
  --card: #FFFFFF;
  --text-primary: #1A1814;
  --text-secondary: #8A8580;
  --accent: #C4793A;
  --accent-light: #F5EDE3;
  --border: #E8E4DE;
  --toggle-bg: #E8E4DE;
  --toggle-active: #1A1814;
  --shadow: 0 1px 3px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.04);
  --green: #27AE60; --green-bg: #EAF7EF;
  --yellow: #E4A000; --yellow-bg: #FEF6E0;
  --red: #E53935; --red-bg: #FDEAEA;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}
html { height: 100%; height: 100dvh; overflow: hidden; -webkit-text-size-adjust: 100%; touch-action: manipulation; }
body {
  font-family: -apple-system, 'Helvetica Neue', Arial, sans-serif;
  background: var(--bg);
  height: 100%; height: 100dvh; overflow: hidden;
  overscroll-behavior: none;
  overscroll-behavior-y: none;
  -webkit-overflow-scrolling: touch;
  user-select: none; -webkit-user-select: none;
  touch-action: manipulation;
  overflow: hidden;
}
/* ‚îÄ‚îÄ APP WRAPPER ‚îÄ‚îÄ */
#app { position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; display: flex; flex-direction: column; overflow: hidden; padding-top: env(safe-area-inset-top, 0px); padding-bottom: env(safe-area-inset-bottom, 0px); }

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
.screen { display: none; flex-direction: column; flex: 1; overflow: hidden; min-height: 0; }
.screen.active { display: flex; }

/* ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ */
.top-bar {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  align-items: center;
  padding: 14px 16px 8px;
  flex-shrink: 0;
  min-height: 52px;
}
.top-bar-left { display: flex; justify-content: flex-start; gap: 8px; align-items: center; }
.top-bar-center { text-align: center; }
.top-bar-center h1 {
  font-family: Georgia, 'Times New Roman', serif;
  font-size: 22px; color: var(--text-primary);
  line-height: 1; font-style: italic; white-space: nowrap;
}
.top-bar-center p { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }
.top-bar-right { display: flex; justify-content: flex-end; gap: 8px; align-items: center; }

.nav-btn {
  background: var(--card); border: none; border-radius: 12px;
  padding: 8px 13px;
  font-family: -apple-system, 'Helvetica Neue', Arial, sans-serif; font-size: 12px; font-weight: 500;
  color: var(--text-secondary); cursor: pointer;
  box-shadow: var(--shadow); white-space: nowrap;
  height: 34px; display: flex; align-items: center;
  -webkit-appearance: none; appearance: none;
}
.icon-btn {
  background: var(--card); border: none; border-radius: 12px;
  width: 34px; height: 34px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; box-shadow: var(--shadow); color: var(--text-secondary);
}
.filter-btn {
  width: 34px; height: 34px;
  background: var(--card); border: none; border-radius: 12px;
  cursor: pointer; box-shadow: var(--shadow);
  display: flex; align-items: center; justify-content: center;
  color: var(--text-secondary); position: relative;
}
.filter-badge {
  position: absolute; top: -3px; right: -3px;
  width: 14px; height: 14px; border-radius: 7px;
  background: var(--accent); color: white;
  font-size: 9px; font-weight: 700;
  display: none; align-items: center; justify-content: center;
}
.filter-badge.show { display: flex; }

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card { background: var(--card); border-radius: 18px; padding: 12px 15px; box-shadow: var(--shadow); flex-shrink: 0; }
.card-label { font-size: 10px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 8px; }

/* ‚îÄ‚îÄ SCREEN 1: SHOT LOG ‚îÄ‚îÄ */
.log-scroll {
  flex: 1; overflow-y: auto; overflow-x: hidden;
  -webkit-overflow-scrolling: touch; overscroll-behavior: contain;
  padding: 8px 16px 4px;
  display: flex; flex-direction: column; gap: 8px; min-height: 0;
  touch-action: pan-y;
}
.log-scroll::-webkit-scrollbar { display: none; }
.save-wrap {
  flex-shrink: 0; padding: 12px 16px 28px;
  background: var(--bg);
}
.save-btn {
  background: var(--text-primary); color: white; border: none;
  border-radius: 20px; padding: 24px 17px;
  font-family: -apple-system, 'Helvetica Neue', Arial, sans-serif; font-size: 18px; font-weight: 600;
  cursor: pointer; width: 100%; transition: all 0.2s;
  -webkit-appearance: none; appearance: none;
  min-height: 70px;
}
.save-btn:active { opacity: 0.8; }

.bean-row { display: flex; align-items: center; justify-content: space-between; }
.bean-name { font-size: 15px; font-weight: 500; color: var(--text-primary); }
.bean-sub { font-size: 12px; color: var(--text-secondary); margin-top: 1px; }
.bean-change { font-size: 12px; font-weight: 500; color: var(--accent); cursor: pointer; background: none; border: none; font-family: -apple-system, 'Helvetica Neue', Arial, sans-serif; }

.two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; flex-shrink: 0; }

.toggle-group { display: flex; gap: 6px; }
.toggle-btn {
  flex: 1; padding: 8px 0; border: none; border-radius: 12px;
  font-family: -apple-system, 'Helvetica Neue', Arial, sans-serif; font-size: 13px; font-weight: 500;
  cursor: pointer; transition: all 0.18s;
  background: var(--toggle-bg); color: var(--text-secondary);
  -webkit-appearance: none; appearance: none;
  -webkit-font-smoothing: antialiased;
}
.toggle-btn.active { background: var(--toggle-active); color: #fff; }

.stepper-card { background: var(--card); border-radius: 18px; padding: 11px 13px; box-shadow: var(--shadow); }
.stepper-label { font-size: 10px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 7px; }
.stepper-label-row { display: flex; align-items: center; gap: 6px; margin-bottom: 7px; }
.stepper-label-row .stepper-label { margin-bottom: 0; }
.stepper { display: flex; align-items: center; justify-content: space-between; }
.stepper-btn {
  width: 34px; height: 34px; border-radius: 10px; border: none;
  background: var(--accent-light); color: var(--accent); font-size: 20px;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: all 0.15s; user-select: none; -webkit-user-select: none;
  touch-action: manipulation; -webkit-appearance: none; appearance: none;
  -webkit-user-select: none; user-select: none;
}
.stepper-btn:active { transform: scale(0.9); background: var(--accent); color: white; }
.stepper-value { font-size: 22px; font-weight: 500; color: var(--text-primary); min-width: 56px; text-align: center; }
.stepper-unit { font-size: 12px; color: var(--text-secondary); font-weight: 400; }
.ratio-chip { background: var(--accent-light); color: var(--accent); font-size: 11px; font-weight: 600; padding: 3px 8px; border-radius: 6px; letter-spacing: 0.03em; white-space: nowrap; }

.ios-toggle { width: 48px; height: 28px; background: #34C759; border-radius: 14px; position: relative; cursor: pointer; transition: background 0.2s; flex-shrink: 0; }
.ios-toggle::after { content: ''; position: absolute; width: 24px; height: 24px; background: white; border-radius: 12px; top: 2px; left: 22px; box-shadow: 0 1px 4px rgba(0,0,0,0.2); transition: left 0.2s; }
.ios-toggle.off { background: var(--toggle-bg); }
.ios-toggle.off::after { left: 2px; }

.puck-row { display: flex; align-items: center; justify-content: space-between; }
.puck-title { font-size: 14px; font-weight: 500; color: var(--text-primary); }
.puck-sub { font-size: 11px; color: var(--text-secondary); margin-top: 1px; }

.notes-input {
  width: 100%; border: none; background: transparent;
  font-family: -apple-system, 'Helvetica Neue', Arial, sans-serif; font-size: 13px; color: var(--text-secondary);
  resize: none; outline: none; height: 28px;
  touch-action: manipulation; user-select: text; -webkit-user-select: text;
}
.auto-badge { font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 5px; letter-spacing: 0.04em; }
.auto-badge.auto { background: var(--accent-light); color: var(--accent); }
.auto-badge.manual { background: var(--toggle-bg); color: var(--text-secondary); }

/* ‚îÄ‚îÄ SCREEN 2: VERLAUF ‚îÄ‚îÄ */
.verlauf-content {
  flex: 1; display: flex; flex-direction: column;
  padding: 8px 16px;
  padding-bottom: 16px;
  gap: 8px; overflow: hidden; min-height: 0;
}

/* Stats strip ‚Äî now at top */
.stats-strip { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; flex-shrink: 0; }
.stat-card { background: var(--card); border-radius: 14px; padding: 10px 10px; box-shadow: var(--shadow); text-align: center; }
.stat-value { font-size: 18px; font-weight: 600; color: var(--text-primary); line-height: 1; }
.stat-label { font-size: 10px; color: var(--text-secondary); margin-top: 3px; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; }

/* Filter bar below stats */
.filter-bar { display: flex; gap: 7px; align-items: center; flex-shrink: 0; }
.filter-scroll { display: flex; gap: 6px; overflow-x: auto; flex: 1; scrollbar-width: none; }
.filter-scroll::-webkit-scrollbar { display: none; }
.filter-chip {
  display: flex; align-items: center; gap: 4px;
  background: var(--card); border: 1.5px solid var(--border); border-radius: 20px;
  padding: 5px 11px;
  font-family: -apple-system, 'Helvetica Neue', Arial, sans-serif; font-size: 12px; font-weight: 500;
  color: var(--text-secondary); cursor: pointer; white-space: nowrap; flex-shrink: 0;
}
.filter-chip.active { background: var(--toggle-active); border-color: var(--toggle-active); color: white; }

/* Table */
.table-wrap {
  flex: 1; overflow-y: auto; overflow-x: hidden;
  background: var(--card); border-radius: 18px;
  box-shadow: var(--shadow); min-height: 0;
  -webkit-overflow-scrolling: touch; overscroll-behavior: contain;
  touch-action: pan-y;
}
.table-wrap::-webkit-scrollbar { display: none; }
table { width: 100%; border-collapse: collapse; }
thead th {
  font-size: 10px; font-weight: 700; color: var(--text-secondary);
  text-transform: uppercase; letter-spacing: 0.06em;
  padding: 12px 13px 9px; text-align: left;
  position: sticky; top: 0; background: var(--card);
  border-bottom: 1px solid var(--border); z-index: 1;
}
thead th:nth-child(3) { text-align: right; }
thead th:last-child { text-align: center; }
tbody tr { border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.12s; }
tbody tr:last-child { border-bottom: none; }
tbody tr:active { background: var(--bg); }
tbody td { padding: 9px 13px; font-size: 13px; color: var(--text-primary); vertical-align: middle; }
.td-date-day { font-size: 12px; font-weight: 500; }
.td-date-sub { font-size: 11px; color: var(--text-secondary); margin-top: 1px; }
.td-bean-name { font-size: 13px; font-weight: 500; line-height: 1.2; }
.td-bean-type { font-size: 11px; color: var(--text-secondary); margin-top: 1px; }
.td-ratio { text-align: right; font-size: 13px; font-weight: 600; white-space: nowrap; }
.td-ampel { text-align: center; }
.ampel { display: inline-flex; width: 24px; height: 24px; border-radius: 50%; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; }
.ampel.green { background: var(--green-bg); color: var(--green); }
.ampel.yellow { background: var(--yellow-bg); color: var(--yellow); }
.ampel.red { background: var(--red-bg); color: var(--red); }
.ampel-icon { display: inline-flex; flex-direction: column; gap: 1.5px; margin-left: 3px; vertical-align: middle; }
.ampel-icon span { display: block; width: 6px; height: 6px; border-radius: 50%; }

.empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; gap: 8px; color: var(--text-secondary); padding: 32px; }
.empty-state-icon { font-size: 32px; opacity: 0.4; }
.empty-state-text { font-size: 13px; font-weight: 500; text-align: center; }

/* ‚îÄ‚îÄ SCREEN 3: DASHBOARD ‚îÄ‚îÄ */
.dash-content { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; padding: 8px 16px 16px; min-height: 0; touch-action: pan-y; }
.dash-content::-webkit-scrollbar { display: none; }
.kpi-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 12px; }
.kpi-card { background: var(--card); border-radius: 14px; padding: 11px 9px; box-shadow: var(--shadow); text-align: center; }
.kpi-value { font-size: 20px; font-weight: 700; color: var(--text-primary); line-height: 1; }
.kpi-label { font-size: 10px; color: var(--text-secondary); margin-top: 3px; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; }
.kpi-delta { font-size: 10px; font-weight: 600; margin-top: 4px; }
.kpi-delta.up { color: var(--green); } .kpi-delta.down { color: var(--red); } .kpi-delta.neutral { color: var(--text-secondary); }
.dash-section { margin-bottom: 14px; }
.dash-section-title { font-family: Georgia, 'Times New Roman', serif; font-style: italic; font-size: 17px; color: var(--text-primary); margin-bottom: 10px; }
.chart-card { background: var(--card); border-radius: 18px; padding: 14px; box-shadow: var(--shadow); margin-bottom: 10px; }
.chart-title { font-size: 11px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 12px; }
.insight-card { border-radius: 16px; padding: 13px 14px; margin-bottom: 8px; display: flex; gap: 12px; align-items: flex-start; }
.insight-card.tip { background: var(--accent-light); }
.insight-card.warn { background: var(--yellow-bg); }
.insight-card.good { background: var(--green-bg); }
.insight-icon { font-size: 20px; flex-shrink: 0; }
.insight-title { font-size: 13px; font-weight: 600; color: var(--text-primary); margin-bottom: 3px; }
.insight-text { font-size: 12px; color: var(--text-secondary); line-height: 1.5; }
.chart-svg { width: 100%; overflow: visible; }
.donut-row { display: flex; align-items: center; gap: 16px; }
.donut-legend { display: flex; flex-direction: column; gap: 6px; }
.donut-legend-item { display: flex; align-items: center; gap: 7px; }
.donut-legend-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.donut-legend-label { font-size: 12px; color: var(--text-secondary); }
.donut-legend-val { font-size: 12px; font-weight: 600; color: var(--text-primary); margin-left: 4px; }
.chart-label { font-family: -apple-system, 'Helvetica Neue', Arial, sans-serif; font-size: 9px; fill: var(--text-secondary); }
.chart-val { font-family: -apple-system, 'Helvetica Neue', Arial, sans-serif; font-size: 10px; font-weight: 600; fill: var(--text-primary); }
.compare-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
.compare-label { font-size: 11px; font-weight: 500; color: var(--text-secondary); width: 60px; flex-shrink: 0; text-align: right; }
.compare-track { flex: 1; height: 20px; background: var(--bg); border-radius: 10px; overflow: hidden; }
.compare-fill { height: 100%; border-radius: 10px; display: flex; align-items: center; padding-right: 8px; justify-content: flex-end; }
.compare-fill-val { font-size: 10px; font-weight: 700; color: white; }

/* ‚îÄ‚îÄ SHEETS ‚îÄ‚îÄ */
.sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.32); backdrop-filter: blur(4px); z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.25s; }
.sheet-overlay.open { opacity: 1; pointer-events: all; }
.bottom-sheet { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card); border-radius: 28px 28px 0 0; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.32,0.72,0,1); z-index: 101; max-height: 85vh; display: flex; flex-direction: column; padding-bottom: var(--safe-bottom); }
.sheet-overlay.open .bottom-sheet { transform: translateY(0); }
.sheet-handle { width: 36px; height: 4px; background: var(--border); border-radius: 2px; margin: 12px auto 0; flex-shrink: 0; }
.sheet-header { display: flex; justify-content: space-between; align-items: center; padding: 14px 20px 0; flex-shrink: 0; }
.sheet-title-text { font-family: Georgia, 'Times New Roman', serif; font-style: italic; font-size: 20px; color: var(--text-primary); }
.sheet-reset { font-size: 12px; font-weight: 500; color: var(--accent); background: none; border: none; cursor: pointer; font-family: -apple-system, 'Helvetica Neue', Arial, sans-serif; }
.sheet-body { overflow-y: auto; padding: 14px 20px 24px; flex: 1; scrollbar-width: none; -webkit-overflow-scrolling: touch; touch-action: pan-y; }
.sheet-body::-webkit-scrollbar { display: none; }
.filter-section { margin-bottom: 18px; }
.filter-section-label { font-size: 11px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.07em; margin-bottom: 10px; }
.chip-group { display: flex; flex-wrap: wrap; gap: 7px; }
.opt-chip { padding: 7px 14px; background: var(--bg); border: 1.5px solid var(--border); border-radius: 20px; font-family: -apple-system, 'Helvetica Neue', Arial, sans-serif; font-size: 13px; font-weight: 500; color: var(--text-secondary); cursor: pointer; transition: all 0.15s; }
.opt-chip.active { background: var(--toggle-active); border-color: var(--toggle-active); color: white; }
.opt-chip.green-chip.active { background: var(--green); border-color: var(--green); }
.opt-chip.yellow-chip.active { background: var(--yellow); border-color: var(--yellow); }
.opt-chip.red-chip.active { background: var(--red); border-color: var(--red); }
.apply-btn { width: 100%; padding: 14px; background: var(--text-primary); color: white; border: none; border-radius: 16px; font-family: -apple-system, 'Helvetica Neue', Arial, sans-serif; font-size: 15px; font-weight: 600; cursor: pointer; margin-top: 4px; }

/* Bean Sheet */
.bean-sheet-actions { display: flex; gap: 8px; padding: 0 20px 14px; flex-shrink: 0; }
.sheet-action-btn { flex: 1; padding: 12px 0; border-radius: 14px; border: none; font-family: -apple-system, 'Helvetica Neue', Arial, sans-serif; font-size: 13px; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }
.btn-fill { background: var(--accent); color: white; }
.btn-new { background: var(--toggle-bg); color: var(--text-secondary); }
.sheet-divider { height: 1px; background: var(--border); margin: 0 20px 12px; flex-shrink: 0; }
.sheet-section-label-sm { font-size: 11px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.06em; padding: 0 20px 10px; flex-shrink: 0; }
.bean-list { padding: 0 12px 8px; overflow-y: auto; flex: 1; min-height: 0; -webkit-overflow-scrolling: touch; }
.bean-list::-webkit-scrollbar { display: none; }
.bean-slot { display: flex; align-items: center; padding: 10px 8px; border-radius: 14px; gap: 12px; min-height: 62px; transition: background 0.15s; }
.bean-slot.filled { cursor: pointer; }
.bean-slot.filled:active { background: var(--bg); }
.bean-slot.selected { background: var(--accent-light); }
.bean-slot.empty { border: 1.5px dashed var(--border); justify-content: center; }
.bean-dot { width: 36px; height: 36px; border-radius: 10px; background: var(--accent-light); display: flex; align-items: center; justify-content: center; font-size: 17px; flex-shrink: 0; }
.bean-item-info { flex: 1; min-width: 0; }
.bean-item-name { font-size: 14px; font-weight: 500; color: var(--text-primary); }
.bean-item-sub { font-size: 12px; color: var(--text-secondary); margin-top: 1px; }
.bean-item-stars { font-size: 11px; margin-top: 2px; color: var(--accent); }
.bean-select-btn { width: 32px; height: 32px; border-radius: 10px; background: var(--bg); border: 1.5px solid var(--border); display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-secondary); font-size: 14px; font-weight: 700; flex-shrink: 0; transition: all 0.15s; }
.bean-select-btn.selected { background: var(--accent); border-color: var(--accent); color: white; }
.bean-slot-empty-text { font-size: 13px; color: var(--text-secondary); opacity: 0.5; }

/* Bean Detail */
.star-row { display: flex; gap: 10px; justify-content: center; margin: 8px 0 16px; }
.star-btn { font-size: 28px; cursor: pointer; opacity: 0.25; transition: all 0.15s; user-select: none; }
.star-btn.active { opacity: 1; }

/* Form fields */
.form-field { margin-bottom: 13px; }
.form-label { font-size: 11px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 6px; display: block; }
.form-input { width: 100%; padding: 11px 13px; background: var(--bg); border: 1.5px solid var(--border); border-radius: 13px; font-family: -apple-system, 'Helvetica Neue', Arial, sans-serif; font-size: 14px; color: var(--text-primary); outline: none; transition: border-color 0.15s; user-select: text; -webkit-user-select: text; }
.form-input:focus { border-color: var(--accent); }

.gram-options { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin: 12px 0; }
.gram-btn { padding: 16px 0; background: var(--bg); border: 2px solid var(--border); border-radius: 14px; font-family: -apple-system, 'Helvetica Neue', Arial, sans-serif; font-size: 15px; font-weight: 600; color: var(--text-primary); cursor: pointer; text-align: center; transition: all 0.15s; }
.gram-btn.active { background: var(--accent-light); border-color: var(--accent); color: var(--accent); }

/* Settings */
.settings-section { margin-bottom: 20px; }
.settings-section-title { font-size: 11px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.07em; margin-bottom: 12px; }
.settings-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); }
.settings-row:last-child { border-bottom: none; }
.settings-row-label { font-size: 14px; font-weight: 500; color: var(--text-primary); }
.settings-row-sub { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
.settings-input { background: var(--bg); border: 1.5px solid var(--border); border-radius: 10px; padding: 6px 10px; font-family: -apple-system, 'Helvetica Neue', Arial, sans-serif; font-size: 13px; color: var(--text-primary); outline: none; width: 90px; text-align: center; user-select: text; -webkit-user-select: text; }
.settings-stepper { display: flex; align-items: center; gap: 8px; }
.settings-stepper-btn { width: 28px; height: 28px; border-radius: 8px; border: none; background: var(--accent-light); color: var(--accent); font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; -webkit-appearance: none; appearance: none; }
.settings-stepper-val { font-size: 14px; font-weight: 600; color: var(--text-primary); min-width: 36px; text-align: center; }
.ampel-settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
.ampel-field { background: var(--bg); border-radius: 12px; padding: 10px 12px; }
.ampel-field-label { font-size: 10px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 6px; }
.ampel-field-inputs { display: flex; align-items: center; gap: 6px; }
.ampel-input { width: 48px; padding: 5px 6px; background: var(--card); border: 1.5px solid var(--border); border-radius: 8px; font-family: -apple-system, 'Helvetica Neue', Arial, sans-serif; font-size: 13px; text-align: center; color: var(--text-primary); outline: none; user-select: text; -webkit-user-select: text; }
.ampel-input:focus { border-color: var(--accent); }
.defaults-toggle { display: flex; gap: 6px; margin-bottom: 12px; }
.defaults-toggle .toggle-btn { padding: 7px 0; font-size: 13px; }

/* Password screen */
#screen-password { background: var(--bg); display: none; align-items: center; justify-content: center; padding: 40px 32px; padding-top: calc(40px + var(--safe-top)); padding-bottom: 40px; }
#screen-password.active { display: flex; flex-direction: column; }
.pw-logo { font-size: 56px; margin-bottom: 24px; }
.pw-title { font-family: Georgia, 'Times New Roman', serif; font-style: italic; font-size: 32px; color: var(--text-primary); margin-bottom: 6px; }
.pw-sub { font-size: 13px; color: var(--text-secondary); margin-bottom: 32px; }
.pw-input { width: 100%; padding: 14px 18px; background: var(--card); border: 2px solid var(--border); border-radius: 16px; font-family: -apple-system, 'Helvetica Neue', Arial, sans-serif; font-size: 16px; color: var(--text-primary); outline: none; text-align: center; transition: border-color 0.2s; margin-bottom: 12px; user-select: text; -webkit-user-select: text; }
.pw-input:focus { border-color: var(--accent); }
.pw-input.error { border-color: var(--red); animation: shake 0.4s ease; }
.pw-btn { width: 100%; padding: 16px; background: var(--text-primary); color: white; border: none; border-radius: 16px; font-family: -apple-system, 'Helvetica Neue', Arial, sans-serif; font-size: 16px; font-weight: 600; cursor: pointer; }
.pw-error { font-size: 12px; color: var(--red); margin-top: 8px; min-height: 18px; text-align: center; }
@keyframes shake { 0%,100% { transform: translateX(0); } 20%,60% { transform: translateX(-6px); } 40%,80% { transform: translateX(6px); } }

/* Popup */
.popup-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(6px); z-index: 200; display: none; align-items: center; justify-content: center; padding: 32px; }
.popup-overlay.open { display: flex; }
.popup-card { background: var(--card); border-radius: 24px; padding: 28px 24px; width: 100%; text-align: center; box-shadow: 0 8px 40px rgba(0,0,0,0.2); }
.popup-icon { font-size: 40px; margin-bottom: 12px; }
.popup-title { font-family: Georgia, 'Times New Roman', serif; font-style: italic; font-size: 22px; color: var(--text-primary); margin-bottom: 8px; }
.popup-text { font-size: 13px; color: var(--text-secondary); line-height: 1.5; margin-bottom: 20px; }
.popup-btns { display: flex; gap: 10px; }
.popup-btn { flex: 1; padding: 13px; border: none; border-radius: 14px; font-family: -apple-system, 'Helvetica Neue', Arial, sans-serif; font-size: 14px; font-weight: 600; cursor: pointer; }
.popup-btn-later { background: var(--bg); color: var(--text-secondary); }
.popup-btn-done { background: var(--green); color: white; }

/* Sync indicator */
.sync-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--green); display: inline-block; flex-shrink: 0; transition: background 0.3s; }
.sync-dot.syncing { background: var(--yellow); animation: pulse 1s infinite; }
.sync-dot.local { background: #3A7EC4; }
.sync-dot.error { background: var(--red); }
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }

.username-id-display {
  font-size: 11px; color: var(--text-secondary); font-family: monospace;
  background: var(--bg); padding: 6px 10px; border-radius: 8px;
  word-break: break-all; flex: 1;
}
.username-status { font-size: 11px; color: var(--text-secondary); margin-top: 4px; }
/* Shot Detail Sheet */
.shot-detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
.shot-detail-item { background: var(--bg); border-radius: 12px; padding: 10px 12px; }
.shot-detail-label { font-size: 10px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px; }
.shot-detail-value { font-size: 16px; font-weight: 600; color: var(--text-primary); }
.shot-detail-unit { font-size: 11px; color: var(--text-secondary); font-weight: 400; }
.shot-detail-note { background: var(--bg); border-radius: 12px; padding: 12px; font-size: 13px; color: var(--text-secondary); line-height: 1.5; margin-bottom: 16px; }
</style>

</head>
<body>
<div id="app">

  <!-- ‚ïê‚ïê PASSWORD SCREEN ‚ïê‚ïê -->

  <div class="screen active" id="screen-password">
    <div class="pw-logo">‚òï</div>
    <div class="pw-title">Espresso Tracker</div>
    <div class="pw-sub">Bitte Passwort eingeben</div>
    <input class="pw-input" type="password" id="pw-input" placeholder="Passwort" autocomplete="current-password">
    <button class="pw-btn" id="pw-btn">Entsperren</button>
    <div class="pw-error" id="pw-error"></div>
  </div>

  <!-- ‚ïê‚ïê SCREEN 1: SHOT LOG ‚ïê‚ïê -->

  <div class="screen" id="screen-log">
    <div class="top-bar">
      <div class="top-bar-left">
        <button class="icon-btn" id="settings-btn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        </button>
      </div>
      <div class="top-bar-center">
        <h1>Shot Log</h1>
        <div style="display:flex;align-items:center;justify-content:center;gap:5px;margin-top:2px;"><span class="sync-dot" id="sync-dot"></span><span id="sync-label" style="font-size:10px;color:var(--text-secondary);"></span></div>
        <p id="current-date"></p>
      </div>
      <div class="top-bar-right">
        <button class="nav-btn" id="to-verlauf-btn">Verlauf ‚Üí</button>
      </div>
    </div>

```
<div class="log-scroll">
  <div class="card">
    <div class="card-label">Bohne</div>
    <div class="bean-row">
      <div>
        <div class="bean-name" id="selected-bean-name">‚Äì</div>
        <div class="bean-sub" id="selected-bean-sub"></div>
      </div>
      <button class="bean-change" id="open-sheet-btn">√Ñndern</button>
    </div>
  </div>

  <div class="two-col">
    <div class="card">
      <div class="card-label">Bezug</div>
      <div class="toggle-group" id="bezug-toggle">
        <button class="toggle-btn">Single</button>
        <button class="toggle-btn active">Double</button>
      </div>
    </div>
    <div class="card">
      <div class="card-label">Siebtr√§ger</div>
      <div class="toggle-group" id="sieb-toggle">
        <button class="toggle-btn">Normal</button>
        <button class="toggle-btn active">Bodenlos</button>
      </div>
    </div>
  </div>

  <div class="two-col">
    <div class="stepper-card">
      <div class="stepper-label">Dosis</div>
      <div class="stepper" id="dosis-stepper" data-step="0.1" data-unit="g" data-dec="1">
        <button class="stepper-btn">‚àí</button>
        <span class="stepper-value">18<span class="stepper-unit">g</span></span>
        <button class="stepper-btn">+</button>
      </div>
    </div>
    <div class="stepper-card">
      <div class="stepper-label-row">
        <span class="stepper-label">Durchlauf</span>
        <span class="auto-badge manual" id="timer-mode-badge">MANUELL</span>
      </div>
      <div class="stepper" id="durchlauf-stepper" data-step="1" data-unit="s" data-dec="0">
        <button class="stepper-btn">‚àí</button>
        <span class="stepper-value">28<span class="stepper-unit">s</span></span>
        <button class="stepper-btn">+</button>
      </div>
    </div>
  </div>

  <div class="stepper-card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:7px;">
      <div class="stepper-label" style="margin-bottom:0">Espresso</div>
      <span class="ratio-chip" id="ratio-chip">1 : 2.0 Ratio</span>
    </div>
    <div class="stepper" id="espresso-stepper" data-step="0.1" data-unit="g" data-dec="1">
      <button class="stepper-btn">‚àí</button>
      <span class="stepper-value">36<span class="stepper-unit">g</span></span>
      <button class="stepper-btn">+</button>
    </div>
  </div>

  <div class="card">
    <div class="puck-row">
      <div>
        <div class="puck-title">Puck Screen</div>
        <div class="puck-sub" id="puck-sub">Verwendet</div>
      </div>
      <div class="ios-toggle" id="puck-toggle"></div>
    </div>
  </div>

  <div class="card">
    <div class="card-label">Notiz</div>
    <textarea class="notes-input" id="notes-input" placeholder="Frucht, S√§ure, S√º√üe ‚Ä¶ (optional)"></textarea>
  </div>
</div>

<div class="save-wrap">
  <button class="save-btn" id="save-btn">Shot speichern</button>
</div>
```

  </div>

  <!-- ‚ïê‚ïê SCREEN 2: VERLAUF ‚ïê‚ïê -->

  <div class="screen" id="screen-verlauf">
    <div class="top-bar">
      <div class="top-bar-left">
        <button class="nav-btn" id="back-from-verlauf">‚Üê Zur√ºck</button>
      </div>
      <div class="top-bar-center">
        <h1>Verlauf</h1>
        <p id="verlauf-sub">0 Shots</p>
      </div>
      <div class="top-bar-right">
        <button class="nav-btn" id="to-dashboard-btn">Dashboard ‚Üí</button>
      </div>
    </div>

```
<div class="verlauf-content">
  <!-- Stats oben -->
  <div class="stats-strip">
    <div class="stat-card"><div class="stat-value" id="stat-total">0</div><div class="stat-label">Shots</div></div>
    <div class="stat-card"><div class="stat-value" id="stat-avg-ratio">‚Äì</div><div class="stat-label">√ò Ratio</div></div>
    <div class="stat-card"><div class="stat-value" id="stat-green-pct">‚Äì</div><div class="stat-label">üü¢ Quote</div></div>
  </div>

  <!-- Filter bar darunter, Filter-Button neben der Tabellen-√úberschrift -->
  <div class="filter-bar">
    <div class="filter-scroll" id="active-filter-chips">
      <span style="font-size:12px;color:var(--text-secondary);align-self:center;white-space:nowrap;">Alle Shots</span>
    </div>
    <button class="filter-btn" id="open-filter-verlauf-btn">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="6" x2="20" y2="6"/><line x1="8" y1="12" x2="16" y2="12"/><line x1="11" y1="18" x2="13" y2="18"/></svg>
      <div class="filter-badge" id="filter-badge-verlauf">0</div>
    </button>
  </div>

  <!-- Tabelle -->
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Datum</th>
          <th>Bohne</th>
          <th style="text-align:right">Ratio</th>
          <th style="text-align:center">
            <span class="ampel-icon">
              <span style="background:var(--red)"></span>
              <span style="background:var(--yellow)"></span>
              <span style="background:var(--green)"></span>
            </span>
          </th>
        </tr>
      </thead>
      <tbody id="shot-table-body"></tbody>
    </table>
  </div>
</div>
```

  </div>

  <!-- ‚ïê‚ïê SCREEN 3: DASHBOARD ‚ïê‚ïê -->

  <div class="screen" id="screen-dashboard">
    <div class="top-bar">
      <div class="top-bar-left">
        <button class="nav-btn" id="back-from-dashboard">‚Üê Zur√ºck</button>
      </div>
      <div class="top-bar-center">
        <h1>Dashboard</h1>
        <p id="dash-sub">Feb 2026</p>
      </div>
      <div class="top-bar-right">
        <button class="filter-btn" id="open-filter-dash-btn">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="6" x2="20" y2="6"/><line x1="8" y1="12" x2="16" y2="12"/><line x1="11" y1="18" x2="13" y2="18"/></svg>
          <div class="filter-badge" id="filter-badge-dash">0</div>
        </button>
      </div>
    </div>
    <div class="dash-content" id="dash-content"></div>
  </div>

</div>

<!-- ‚ïê‚ïê FILTER SHEET ‚ïê‚ïê -->

<div class="sheet-overlay" id="filter-overlay">
  <div class="bottom-sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <span class="sheet-title-text">Filtern</span>
      <button class="sheet-reset" id="reset-filters-btn">Zur√ºcksetzen</button>
    </div>
    <div class="sheet-body">
      <div class="filter-section">
        <div class="filter-section-label">Zeitraum</div>
        <div class="chip-group">
          <div class="opt-chip" data-filter="time" data-val="today">Heute</div>
          <div class="opt-chip" data-filter="time" data-val="week">Diese Woche</div>
          <div class="opt-chip" data-filter="time" data-val="kw">KW <span id="kw-label"></span></div>
          <div class="opt-chip" data-filter="time" data-val="month">Dieser Monat</div>
          <div class="opt-chip" data-filter="time" data-val="q1">Q1</div>
          <div class="opt-chip" data-filter="time" data-val="q2">Q2</div>
          <div class="opt-chip" data-filter="time" data-val="q3">Q3</div>
          <div class="opt-chip" data-filter="time" data-val="q4">Q4</div>
          <div class="opt-chip" data-filter="time" data-val="year">Dieses Jahr</div>
        </div>
      </div>
      <div class="filter-section">
        <div class="filter-section-label">Wertung</div>
        <div class="chip-group">
          <div class="opt-chip green-chip" data-filter="ampel" data-val="green">üü¢ Gr√ºn</div>
          <div class="opt-chip yellow-chip" data-filter="ampel" data-val="yellow">üü° Gelb</div>
          <div class="opt-chip red-chip" data-filter="ampel" data-val="red">üî¥ Rot</div>
        </div>
      </div>
      <div class="filter-section">
        <div class="filter-section-label">Bezug</div>
        <div class="chip-group">
          <div class="opt-chip" data-filter="type" data-val="Single">Single</div>
          <div class="opt-chip" data-filter="type" data-val="Double">Double</div>
        </div>
      </div>
      <div class="filter-section">
        <div class="filter-section-label">Siebtr√§ger</div>
        <div class="chip-group">
          <div class="opt-chip" data-filter="basket" data-val="Normal">Normal</div>
          <div class="opt-chip" data-filter="basket" data-val="Bodenlos">Bodenlos</div>
        </div>
      </div>
      <div class="filter-section">
        <div class="filter-section-label">Bohne</div>
        <div class="chip-group" id="bean-filter-group"></div>
      </div>
      <div class="filter-section">
        <div class="filter-section-label">Puck Screen</div>
        <div class="chip-group">
          <div class="opt-chip" data-filter="puck" data-val="true">Verwendet</div>
          <div class="opt-chip" data-filter="puck" data-val="false">Nicht verwendet</div>
        </div>
      </div>
      <button class="apply-btn" id="apply-filter-btn">Anwenden</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê SHOT DETAIL SHEET ‚ïê‚ïê -->

<div class="sheet-overlay" id="shot-detail-overlay">
  <div class="bottom-sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <span class="sheet-title-text" id="shot-detail-title">Shot</span>
      <button class="sheet-reset" id="delete-shot-btn" style="color:var(--red);">L√∂schen</button>
    </div>
    <div class="sheet-body">
      <div id="shot-detail-ampel-row" style="display:flex;align-items:center;gap:10px;margin-bottom:16px;">
        <span id="shot-detail-ampel" class="ampel green" style="width:32px;height:32px;font-size:14px;">‚óè</span>
        <span id="shot-detail-ampel-label" style="font-size:13px;font-weight:600;color:var(--text-primary);"></span>
      </div>
      <div class="shot-detail-grid">
        <div class="shot-detail-item">
          <div class="shot-detail-label">Dosis</div>
          <div class="shot-detail-value" id="sd-dosis">‚Äì<span class="shot-detail-unit">g</span></div>
        </div>
        <div class="shot-detail-item">
          <div class="shot-detail-label">Espresso</div>
          <div class="shot-detail-value" id="sd-espresso">‚Äì<span class="shot-detail-unit">g</span></div>
        </div>
        <div class="shot-detail-item">
          <div class="shot-detail-label">Ratio</div>
          <div class="shot-detail-value" id="sd-ratio">‚Äì</div>
        </div>
        <div class="shot-detail-item">
          <div class="shot-detail-label">Durchlauf</div>
          <div class="shot-detail-value" id="sd-zeit">‚Äì<span class="shot-detail-unit">s</span></div>
        </div>
        <div class="shot-detail-item">
          <div class="shot-detail-label">Bezug</div>
          <div class="shot-detail-value" id="sd-type" style="font-size:13px;">‚Äì</div>
        </div>
        <div class="shot-detail-item">
          <div class="shot-detail-label">Siebtr√§ger</div>
          <div class="shot-detail-value" id="sd-basket" style="font-size:13px;">‚Äì</div>
        </div>
      </div>
      <div id="sd-note-wrap" style="display:none;">
        <div class="form-label" style="margin-bottom:8px;">Notiz</div>
        <div class="shot-detail-note" id="sd-note"></div>
      </div>
      <div style="margin-top:4px;">
        <div class="shot-detail-item" style="display:flex;gap:8px;align-items:center;">
          <div class="shot-detail-label" style="margin-bottom:0;">Puck Screen</div>
          <div style="font-size:13px;font-weight:500;color:var(--text-primary);margin-left:auto;" id="sd-puck">‚Äì</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê BEAN SHEET ‚ïê‚ïê -->

<div class="sheet-overlay" id="bean-sheet-overlay">
  <div class="bottom-sheet">
    <div class="sheet-handle"></div>
    <div style="font-family:Georgia,'Times New Roman',serif;font-style:italic;font-size:20px;color:var(--text-primary);padding:14px 20px 10px;flex-shrink:0;">Bohne w√§hlen</div>
    <div class="bean-sheet-actions">
      <button class="sheet-action-btn btn-fill" id="btn-fill-bean">‚òï Bohne auff√ºllen</button>
      <button class="sheet-action-btn btn-new" id="btn-new-bean">Ôºã Neue Bohne</button>
    </div>
    <div class="sheet-divider"></div>
    <div class="sheet-section-label-sm">Gespeicherte Bohnen</div>
    <div class="bean-list" id="bean-list"></div>
    <div style="padding:12px 20px;flex-shrink:0;">
      <button class="apply-btn" id="confirm-bean-selection-btn" style="background:var(--accent);">Auswahl best√§tigen</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê FILL BEAN SELECT SHEET ‚ïê‚ïê -->

<div class="sheet-overlay" id="fill-select-overlay">
  <div class="bottom-sheet">
    <div class="sheet-handle"></div>
    <div style="font-family:Georgia,'Times New Roman',serif;font-style:italic;font-size:20px;color:var(--text-primary);padding:14px 20px 10px;flex-shrink:0;">Welche Bohne auff√ºllen?</div>
    <div class="bean-list" id="fill-bean-list" style="padding:0 12px;"></div>
  </div>
</div>

<!-- ‚ïê‚ïê BEAN DETAIL SHEET ‚ïê‚ïê -->

<div class="sheet-overlay" id="bean-detail-overlay">
  <div class="bottom-sheet">
    <div class="sheet-handle"></div>
    <div style="font-family:Georgia,'Times New Roman',serif;font-style:italic;font-size:20px;color:var(--text-primary);padding:14px 20px 6px;flex-shrink:0;" id="bean-detail-title">Bohne</div>
    <div class="sheet-body">
      <div class="filter-section-label" style="margin-bottom:8px;">Bewertung</div>
      <div class="star-row" id="star-row">
        <span class="star-btn" data-star="1">‚òÖ</span>
        <span class="star-btn" data-star="2">‚òÖ</span>
        <span class="star-btn" data-star="3">‚òÖ</span>
        <span class="star-btn" data-star="4">‚òÖ</span>
        <span class="star-btn" data-star="5">‚òÖ</span>
      </div>
      <button class="apply-btn" id="save-star-btn" style="background:var(--accent);margin-bottom:10px;">Bewertung speichern</button>
      <button class="apply-btn" id="delete-bean-btn" style="background:var(--red-bg);color:var(--red);">üóë Bohne l√∂schen</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê GRAM SHEET ‚ïê‚ïê -->

<div class="sheet-overlay" id="gram-sheet-overlay">
  <div class="bottom-sheet">
    <div class="sheet-handle"></div>
    <div style="padding:14px 20px 0;flex-shrink:0;">
      <div style="font-family:Georgia,'Times New Roman',serif;font-style:italic;font-size:20px;color:var(--text-primary);margin-bottom:4px;" id="gram-sheet-title">Menge eingef√ºllt</div>
      <div style="font-size:13px;color:var(--text-secondary);" id="gram-sheet-sub">Wie viel Gramm kamen in die M√ºhle?</div>
      <div class="gram-options">
        <button class="gram-btn" data-gram="250">250g</button>
        <button class="gram-btn" data-gram="500">500g</button>
        <button class="gram-btn" data-gram="1000">1 kg</button>
      </div>
      <button class="apply-btn" id="confirm-gram-btn">Best√§tigen</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê NEW BEAN SHEET ‚ïê‚ïê -->

<div class="sheet-overlay" id="new-bean-overlay">
  <div class="bottom-sheet">
    <div class="sheet-handle"></div>
    <div style="font-family:Georgia,'Times New Roman',serif;font-style:italic;font-size:20px;color:var(--text-primary);padding:14px 20px 0;flex-shrink:0;">Neue Bohne</div>
    <div class="sheet-body">
      <div class="form-field">
        <label class="form-label">Name / R√∂sterei</label>
        <input class="form-input" id="new-bean-name" type="text" placeholder="z.B. Gardelli">
      </div>
      <div class="form-field">
        <label class="form-label">Details</label>
        <input class="form-input" id="new-bean-sub" type="text" placeholder="z.B. Ethiopia Guji ¬∑ Hell">
      </div>
      <div class="form-field">
        <label class="form-label">Menge (in M√ºhle)</label>
        <div class="gram-options" style="margin:0;">
          <button class="gram-btn new-gram-btn" data-gram="250">250g</button>
          <button class="gram-btn new-gram-btn" data-gram="500">500g</button>
          <button class="gram-btn new-gram-btn" data-gram="1000">1 kg</button>
        </div>
      </div>
      <div class="form-field">
        <label class="form-label">Emoji</label>
        <input class="form-input" id="new-bean-emoji" type="text" placeholder="ü´ò" maxlength="2" style="text-align:center;font-size:20px;">
      </div>
      <button class="apply-btn" id="confirm-new-bean-btn" style="background:var(--accent);">Bohne hinzuf√ºgen & ausw√§hlen</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê SETTINGS SHEET ‚ïê‚ïê -->

<div class="sheet-overlay" id="settings-overlay">
  <div class="bottom-sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header"><span class="sheet-title-text">Einstellungen</span></div>
    <div class="sheet-body">
      <div class="settings-section">
        <div class="settings-section-title">Konto &amp; Ger√§t</div>
        <div class="settings-row" style="margin-bottom:10px;">
          <div><div class="settings-row-label">Benutzername</div></div>
          <input class="settings-input" id="setting-username" type="text" placeholder="z.B. max_espresso" style="width:130px;">
        </div>
        <button class="apply-btn" id="save-username-btn" style="background:var(--accent);margin-bottom:10px;">Benutzername speichern</button>
        <div class="settings-row" style="margin-bottom:6px;">
          <div><div class="settings-row-label">Ger√§t-ID</div></div>
        </div>
        <div class="username-id-display" id="device-id-display"></div>
        <div class="username-status" id="username-status"></div>
      </div>
      <div class="settings-section">
        <div class="settings-section-title">Equipment</div>
        <div class="settings-row">
          <div><div class="settings-row-label">Maschine</div></div>
          <input class="settings-input" id="setting-machine" type="text" placeholder="z.B. Gaggia">
        </div>
        <div class="settings-row">
          <div><div class="settings-row-label">M√ºhle</div></div>
          <input class="settings-input" id="setting-grinder" type="text" placeholder="z.B. Niche">
        </div>
      </div>
      <div class="settings-section">
        <div class="settings-section-title">Standardwerte</div>
        <div class="defaults-toggle">
          <button class="toggle-btn active" id="defaults-single-btn">Single</button>
          <button class="toggle-btn" id="defaults-double-btn">Double</button>
        </div>
        <div id="defaults-single" class="defaults-panel">
          <div class="settings-row">
            <div><div class="settings-row-label">Dosis</div></div>
            <div style="display:flex;align-items:center;gap:6px;">
              <input class="settings-input" id="setting-default-dosis-single" type="number" step="0.1" min="1" max="30" value="14" style="width:64px;">
              <span style="font-size:12px;color:var(--text-secondary)">g</span>
            </div>
          </div>
          <div class="settings-row">
            <div><div class="settings-row-label">Durchlaufzeit</div></div>
            <div style="display:flex;align-items:center;gap:6px;">
              <input class="settings-input" id="setting-default-zeit-single" type="number" step="1" min="1" max="60" value="25" style="width:64px;">
              <span style="font-size:12px;color:var(--text-secondary)">s</span>
            </div>
          </div>
          <div class="settings-row">
            <div><div class="settings-row-label">Espresso</div></div>
            <div style="display:flex;align-items:center;gap:6px;">
              <input class="settings-input" id="setting-default-espresso-single" type="number" step="0.1" min="1" max="60" value="25" style="width:64px;">
              <span style="font-size:12px;color:var(--text-secondary)">g</span>
            </div>
          </div>
        </div>
        <div id="defaults-double" class="defaults-panel" style="display:none;">
          <div class="settings-row">
            <div><div class="settings-row-label">Dosis</div></div>
            <div style="display:flex;align-items:center;gap:6px;">
              <input class="settings-input" id="setting-default-dosis-double" type="number" step="0.1" min="1" max="30" value="18" style="width:64px;">
              <span style="font-size:12px;color:var(--text-secondary)">g</span>
            </div>
          </div>
          <div class="settings-row">
            <div><div class="settings-row-label">Durchlaufzeit</div></div>
            <div style="display:flex;align-items:center;gap:6px;">
              <input class="settings-input" id="setting-default-zeit-double" type="number" step="1" min="1" max="60" value="28" style="width:64px;">
              <span style="font-size:12px;color:var(--text-secondary)">s</span>
            </div>
          </div>
          <div class="settings-row">
            <div><div class="settings-row-label">Espresso</div></div>
            <div style="display:flex;align-items:center;gap:6px;">
              <input class="settings-input" id="setting-default-espresso-double" type="number" step="0.1" min="1" max="60" value="36" style="width:64px;">
              <span style="font-size:12px;color:var(--text-secondary)">g</span>
            </div>
          </div>
        </div>
      </div>
      <div class="settings-section">
        <div class="settings-section-title">Auto-Timer</div>
        <div class="settings-row">
          <div><div class="settings-row-label">Dezibel-Timer</div><div class="settings-row-sub">Mikrofon startet/stoppt Durchlaufzeit</div></div>
          <div class="ios-toggle off" id="setting-autotimer"></div>
        </div>
      </div>
      <div class="settings-section">
        <div class="settings-section-title">Reinigungserinnerung</div>
        <div class="settings-row">
          <div><div class="settings-row-label">Aktiv</div></div>
          <div class="ios-toggle off" id="setting-cleaning-active"></div>
        </div>
        <div class="settings-row">
          <div><div class="settings-row-label">Alle x Bez√ºge</div><div class="settings-row-sub" id="cleaning-counter-sub">‚Äî</div></div>
          <div class="settings-stepper">
            <button class="settings-stepper-btn" id="cleaning-minus">‚àí</button>
            <span class="settings-stepper-val" id="cleaning-val">20</span>
            <button class="settings-stepper-btn" id="cleaning-plus">+</button>
          </div>
        </div>
      </div>
      <div class="settings-section">
        <div class="settings-section-title">Ampel-Grenzen</div>
        <div class="ampel-settings-grid">
          <div class="ampel-field">
            <div class="ampel-field-label" style="color:var(--green)">üü¢ Ratio</div>
            <div class="ampel-field-inputs">
              <input class="ampel-input" id="amp-ratio-g-min" value="1.8">
              <span style="font-size:11px;color:var(--text-secondary)">‚Äì</span>
              <input class="ampel-input" id="amp-ratio-g-max" value="2.8">
            </div>
          </div>
          <div class="ampel-field">
            <div class="ampel-field-label" style="color:var(--green)">üü¢ Zeit (s)</div>
            <div class="ampel-field-inputs">
              <input class="ampel-input" id="amp-zeit-g-min" value="20">
              <span style="font-size:11px;color:var(--text-secondary)">‚Äì</span>
              <input class="ampel-input" id="amp-zeit-g-max" value="30">
            </div>
          </div>
          <div class="ampel-field">
            <div class="ampel-field-label" style="color:var(--yellow)">üü° Ratio</div>
            <div class="ampel-field-inputs">
              <input class="ampel-input" id="amp-ratio-y-min" value="1.4">
              <span style="font-size:11px;color:var(--text-secondary)">‚Äì</span>
              <input class="ampel-input" id="amp-ratio-y-max" value="3.0">
            </div>
          </div>
          <div class="ampel-field">
            <div class="ampel-field-label" style="color:var(--yellow)">üü° Zeit (s)</div>
            <div class="ampel-field-inputs">
              <input class="ampel-input" id="amp-zeit-y-min" value="18">
              <span style="font-size:11px;color:var(--text-secondary)">‚Äì</span>
              <input class="ampel-input" id="amp-zeit-y-max" value="35">
            </div>
          </div>
        </div>
        <button class="apply-btn" id="save-ampel-btn" style="margin-top:12px;background:var(--accent);">Grenzen speichern</button>
      </div>
      <div class="settings-section">
        <div class="settings-section-title">Einheit</div>
        <div class="settings-row">
          <div><div class="settings-row-label">Gewicht</div></div>
          <div class="toggle-group" style="gap:6px;">
            <button class="toggle-btn active" id="unit-g-btn" style="padding:6px 14px;font-size:12px;">g</button>
            <button class="toggle-btn" id="unit-ml-btn" style="padding:6px 14px;font-size:12px;">ml</button>
          </div>
        </div>
      </div>
      <div class="settings-section">
        <div class="settings-section-title">Daten</div>
        <button class="apply-btn" id="export-csv-btn" style="background:var(--toggle-active);margin-bottom:10px;">üì• CSV exportieren</button>
        <button class="apply-btn" id="import-csv-btn" style="background:var(--accent);">üì§ CSV importieren</button>
        <input type="file" id="import-file-input" accept=".csv" style="display:none;">
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê CLEANING POPUP ‚ïê‚ïê -->

<div class="popup-overlay" id="cleaning-popup">
  <div class="popup-card">
    <div class="popup-icon">üßπ</div>
    <div class="popup-title">Reinigung f√§llig!</div>
    <div class="popup-text" id="cleaning-popup-text">Zeit die Maschine zu reinigen!</div>
    <div class="popup-btns">
      <button class="popup-btn popup-btn-later" id="cleaning-later-btn">Jetzt nicht</button>
      <button class="popup-btn popup-btn-done" id="cleaning-done-btn">‚úì Gereinigt</button>
    </div>
  </div>
</div>

<script>
'use strict';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUPABASE SETUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUPABASE_URL = 'https://ieswqwqagdxmghkwseze.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imllc3dxd3FhZ2R4bWdoa3dzZXplIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0NjYyNDMsImV4cCI6MjA4NzA0MjI0M30.VrYDrr4YwCXMW7ZjJ-P0jqkBh5XAMCPi_CqNExrzcwk';

// Note: Replace SUPABASE_KEY with your actual anon/publishable JWT key from Supabase dashboard
// The key format must be the full JWT, not the sb_publishable_ prefix format
const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_KEY);

// ‚îÄ‚îÄ Device ID (persists in localStorage as fallback identifier) ‚îÄ‚îÄ
function getDeviceId() {
  let id = localStorage.getItem('espresso_device_id');
  if (!id) {
    id = 'dev_' + Date.now() + '_' + Math.random().toString(36).slice(2, 9);
    localStorage.setItem('espresso_device_id', id);
  }
  return id;
}
let DEVICE_ID = getDeviceId();

// Username ‚Üí DeviceID Verkn√ºpfung via Supabase
async function saveUsername(username) {
  if (!username.trim()) return;
  const clean = username.trim().toLowerCase().replace(/[^a-z0-9_]/g, '_');
  try {
    // Pr√ºfen ob Username schon existiert
    const { data } = await db.from('usernames').select('device_id').eq('username', clean).maybeSingle();
    if (data && data.device_id && data.device_id !== DEVICE_ID) {
      // Username geh√∂rt anderem Ger√§t ‚Üí fragen ob √ºbernehmen
      if (confirm(`Benutzername "${clean}" gefunden. Daten von diesem Konto laden?`)) {
        const oldId = DEVICE_ID;
        DEVICE_ID = data.device_id;
        localStorage.setItem('espresso_device_id', DEVICE_ID);
        document.getElementById('device-id-display').textContent = DEVICE_ID;
        await dbLoadAll();
        await initAppUI();
        document.getElementById('username-status').textContent = '‚úì Konto verkn√ºpft!';
        document.getElementById('username-status').style.color = 'var(--green)';
        return;
      }
    }
    // Username f√ºr dieses Ger√§t speichern/√ºberschreiben
    await db.from('usernames').upsert({ username: clean, device_id: DEVICE_ID }, { onConflict: 'username' });
    localStorage.setItem('espresso_username', clean);
    document.getElementById('username-status').textContent = `‚úì Als "${clean}" gespeichert`;
    document.getElementById('username-status').style.color = 'var(--green)';
    setTimeout(() => { document.getElementById('username-status').textContent = ''; }, 3000);
  } catch(e) {
    console.warn('Username save failed:', e);
    // Lokal speichern als Fallback
    localStorage.setItem('espresso_username', clean);
    document.getElementById('username-status').textContent = '‚úì Lokal gespeichert';
    document.getElementById('username-status').style.color = 'var(--text-secondary)';
  }
}

// ‚îÄ‚îÄ Sync indicator ‚îÄ‚îÄ
// state: 'syncing' = gelb blinkend, 'ok' = gr√ºn (Supabase), 'local' = blau (localStorage), 'error' = rot
function setSyncState(state) {
  const dot = document.getElementById('sync-dot');
  if (!dot) return;
  if (state === 'syncing') dot.className = 'sync-dot syncing';
  else if (state === 'ok') dot.className = 'sync-dot';
  else if (state === 'local') dot.className = 'sync-dot local';
  else if (state === 'error') dot.className = 'sync-dot error';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PREVENT DOUBLE-TAP ZOOM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Prevent double-tap zoom on non-input elements
let lastTap = 0;
document.addEventListener('touchend', e => {
  const tag = e.target.tagName.toLowerCase();
  if (tag === 'input' || tag === 'textarea') return;
  const now = Date.now();
  if (now - lastTap < 300) {
    e.preventDefault();
  }
  lastTap = now;
}, { passive: false });

document.addEventListener('touchmove', e => {
  if (!e.target.closest('.log-scroll, .dash-content, .table-wrap, .sheet-body, .bean-list, .fill-bean-list')) {
    e.preventDefault();
  }
}, { passive: false });
document.addEventListener('gesturestart', e => e.preventDefault(), { passive: false });
document.addEventListener('gesturechange', e => e.preventDefault(), { passive: false });

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PASSWORD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PW_HASH = '386be7b039782f54062ce0827b14c23a13abae3248bf6e71dbfbeb5b5b103d94';
const AUTH_KEY = 'espresso_auth_v1';

async function sha256(msg) {
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(msg));
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}

async function checkPassword() {
  const val = document.getElementById('pw-input').value;
  const hash = await sha256(val);
  if (hash === PW_HASH) {
    localStorage.setItem(AUTH_KEY, '1');
    showScreen('screen-log');
    initApp();
  } else {
    const inp = document.getElementById('pw-input');
    inp.classList.add('error');
    document.getElementById('pw-error').textContent = 'Falsches Passwort';
    setTimeout(() => inp.classList.remove('error'), 500);
  }
}

document.getElementById('pw-btn').addEventListener('click', checkPassword);
document.getElementById('pw-input').addEventListener('keydown', e => { if (e.key === 'Enter') checkPassword(); });

if (localStorage.getItem(AUTH_KEY) === '1') {
  showScreen('screen-log');
  initApp();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOCAL CACHE (fallback + fast reads)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadLocal(key, def) {
  try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : def; } catch(e) { return def; }
}
function saveLocal(key, val) {
  try { localStorage.setItem(key, JSON.stringify(val)); } catch(e) {}
}

let beans = loadLocal('espresso_beans_v2', [
  {id: Date.now(), name:"Gardelli", sub:"Ethiopia Guji ¬∑ Hell", emoji:"ü´ò", stars:0, totalGrams:0},
  {id: Date.now()+1, name:"The Barn", sub:"Colombia ¬∑ Mittel", emoji:"‚òï", stars:0, totalGrams:0},
  {id: Date.now()+2, name:"Five Elephant", sub:"Kenya ¬∑ Hell", emoji:"üåø", stars:0, totalGrams:0},
]);
let shots = loadLocal('espresso_shots_v2', []).map(s => ({...s, date: new Date(s.date)}));
let settings = loadLocal('espresso_settings_v2', {
  machine: '', grinder: '',
  autoTimer: false,
  cleaningActive: false, cleaningEvery: 20, cleaningCounter: 0,
  defaultsSingle: { dosis: 14, zeit: 25, espresso: 25 },
  defaultsDouble: { dosis: 18, zeit: 28, espresso: 36 },
  unit: 'g',
  ampel: { ratioGMin:1.8, ratioGMax:2.8, zeitGMin:20, zeitGMax:30, ratioYMin:1.4, ratioYMax:3.0, zeitYMin:18, zeitYMax:35 }
});
let selectedBeanId = loadLocal('espresso_selected_bean_v2', null);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUPABASE DB OPERATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function dbLoadAll() {
  setSyncState('syncing');
  try {
    const [beansRes, shotsRes, settingsRes] = await Promise.all([
      db.from('beans').select('*').eq('device_id', DEVICE_ID).order('created_at'),
      db.from('shots').select('*').eq('device_id', DEVICE_ID).order('shot_date', { ascending: false }),
      db.from('settings').select('*').eq('device_id', DEVICE_ID).maybeSingle()
    ]);

    if (beansRes.data && beansRes.data.length > 0) {
      beans = beansRes.data.map(b => ({
        id: b.bean_id, name: b.name, sub: b.sub,
        emoji: b.emoji, stars: b.stars, totalGrams: b.total_grams
      }));
      saveLocal('espresso_beans_v2', beans);
    } else if (beans.length > 0) {
      await dbSaveAllBeans();
    }

    if (shotsRes.data && shotsRes.data.length > 0) {
      shots = shotsRes.data.map(s => ({
        id: s.id,
        date: new Date(s.shot_date),
        bean: s.bean, beanSub: s.bean_sub,
        type: s.type, basket: s.basket,
        puck: s.puck, dosis: parseFloat(s.dosis),
        espresso: parseFloat(s.espresso), ratio: parseFloat(s.ratio),
        zeit: s.zeit, note: s.note
      }));
      saveLocal('espresso_shots_v2', shots);
    }

    if (settingsRes.data) {
      const r = settingsRes.data;
      settings = {
        machine: r.machine || '',
        grinder: r.grinder || '',
        autoTimer: r.auto_timer,
        cleaningActive: r.cleaning_active,
        cleaningEvery: r.cleaning_every,
        cleaningCounter: r.cleaning_counter,
        defaultsSingle: r.defaults_single,
        defaultsDouble: r.defaults_double,
        unit: r.unit,
        ampel: r.ampel,
      };
      // Bean-ID nur √ºbernehmen wenn Supabase einen Wert hat
      if (r.selected_bean_id !== null && r.selected_bean_id !== undefined) {
        selectedBeanId = r.selected_bean_id;
        saveLocal('espresso_selected_bean_v2', String(selectedBeanId));
      }
      saveLocal('espresso_settings_v2', settings);
    } else {
      await dbSaveSettings();
    }

    setSyncState('ok');
  } catch(e) {
    console.warn('Supabase load failed, using local cache:', e);
    setSyncState('local');
  }
}

async function dbSaveAllBeans() {
  try {
    const rows = beans.map(b => ({
      device_id: DEVICE_ID, bean_id: b.id,
      name: b.name, sub: b.sub, emoji: b.emoji,
      stars: b.stars, total_grams: b.totalGrams
    }));
    await db.from('beans').upsert(rows, { onConflict: 'device_id,bean_id' });
  } catch(e) { console.warn('Bean save failed:', e); }
}

async function dbSaveBean(bean) {
  saveLocal('espresso_beans_v2', beans);
  try {
    await db.from('beans').upsert({
      device_id: DEVICE_ID, bean_id: bean.id,
      name: bean.name, sub: bean.sub, emoji: bean.emoji,
      stars: bean.stars, total_grams: bean.totalGrams
    }, { onConflict: 'device_id,bean_id' });
  } catch(e) { console.warn('Bean upsert failed:', e); }
}

async function dbDeleteBean(beanId) {
  saveLocal('espresso_beans_v2', beans);
  try {
    await db.from('beans').delete().eq('device_id', DEVICE_ID).eq('bean_id', beanId);
  } catch(e) { console.warn('Bean delete failed:', e); }
}

async function dbSaveShot(shot) {
  saveLocal('espresso_shots_v2', shots);
  setSyncState('syncing');
  try {
    const { data } = await db.from('shots').insert({
      device_id: DEVICE_ID,
      shot_date: shot.date.toISOString(),
      bean: shot.bean, bean_sub: shot.beanSub || '',
      type: shot.type, basket: shot.basket,
      puck: shot.puck, dosis: shot.dosis,
      espresso: shot.espresso, ratio: shot.ratio,
      zeit: shot.zeit, note: shot.note || ''
    }).select().single();
    if (data) {
      shot.id = data.id;
      saveLocal('espresso_shots_v2', shots);
    }
    setSyncState('ok');
  } catch(e) {
    console.warn('Shot save failed, stored locally:', e);
    setSyncState('local');
  }
}

async function dbDeleteShot(shotId) {
  saveLocal('espresso_shots_v2', shots);
  try {
    if (typeof shotId === 'number') {
      await db.from('shots').delete().eq('id', shotId).eq('device_id', DEVICE_ID);
    }
  } catch(e) { console.warn('Shot delete failed:', e); }
}

async function dbSaveSettings() {
  saveLocal('espresso_settings_v2', settings);
  saveLocal('espresso_selected_bean_v2', selectedBeanId);
  try {
    await db.from('settings').upsert({
      device_id: DEVICE_ID,
      machine: settings.machine,
      grinder: settings.grinder,
      auto_timer: settings.autoTimer,
      cleaning_active: settings.cleaningActive,
      cleaning_every: settings.cleaningEvery,
      cleaning_counter: settings.cleaningCounter,
      defaults_single: settings.defaultsSingle,
      defaults_double: settings.defaultsDouble,
      unit: settings.unit,
      ampel: settings.ampel,
      selected_bean_id: selectedBeanId,
      updated_at: new Date().toISOString()
    }, { onConflict: 'device_id' });
  } catch(e) { console.warn('Settings save failed:', e); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AMPEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getAmpel(r, z) {
  const a = settings.ampel;
  let rs = 'red';
  if (r >= a.ratioGMin && r <= a.ratioGMax) rs = 'green';
  else if (r >= a.ratioYMin && r <= a.ratioYMax) rs = 'yellow';
  let zs = 'red';
  if (z >= a.zeitGMin && z <= a.zeitGMax) zs = 'green';
  else if (z >= a.zeitYMin && z <= a.zeitYMax) zs = 'yellow';
  if (rs === 'red' || zs === 'red') return 'red';
  if (rs === 'yellow' || zs === 'yellow') return 'yellow';
  return 'green';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DAYS = ['So','Mo','Di','Mi','Do','Fr','Sa'];
const MONTHS = ['Jan','Feb','M√§r','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];
function fmtDate(d) { return `${DAYS[d.getDay()]}, ${d.getDate()}. ${MONTHS[d.getMonth()]}`; }
function fmtTime(d) { return d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0'); }
function getKW(d) { const j = new Date(d.getFullYear(),0,1); return Math.ceil(((d-j)/86400000+j.getDay()+1)/7); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

document.getElementById('to-verlauf-btn').addEventListener('click', () => { renderVerlauf(); showScreen('screen-verlauf'); });
document.getElementById('back-from-verlauf').addEventListener('click', () => showScreen('screen-log'));
document.getElementById('to-dashboard-btn').addEventListener('click', () => { buildDashboard(); showScreen('screen-dashboard'); });
document.getElementById('back-from-dashboard').addEventListener('click', () => showScreen('screen-verlauf'));

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOGGLES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.querySelectorAll('.toggle-group').forEach(group => {
  group.querySelectorAll('.toggle-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      group.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      // Wenn Bezug-Toggle gewechselt wird, Standardwerte laden
      if (group.id === 'bezug-toggle') {
        const isDouble = btn.textContent.trim() === 'Double';
        const defs = isDouble ? (settings.defaultsDouble || {}) : (settings.defaultsSingle || {});
        if (defs.dosis) setStepperVal('dosis-stepper', defs.dosis);
        if (defs.zeit) setStepperVal('durchlauf-stepper', defs.zeit);
        if (defs.espresso) setStepperVal('espresso-stepper', defs.espresso);
      }
    });
  });
});

document.getElementById('puck-toggle').addEventListener('click', function() {
  this.classList.toggle('off');
  document.getElementById('puck-sub').textContent = this.classList.contains('off') ? 'Nicht verwendet' : 'Verwendet';
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STEPPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const stepperState = {};

function initStepper(id, initVal) {
  const s = document.getElementById(id);
  if (!s) return;
  stepperState[id] = initVal;
  const step = parseFloat(s.dataset.step);
  const unit = s.dataset.unit;
  const dec = parseInt(s.dataset.dec);
  const el = s.querySelector('.stepper-value');

  function render() {
    el.innerHTML = (dec > 0 ? stepperState[id].toFixed(dec) : stepperState[id]) + `<span class="stepper-unit">${unit}</span>`;
    updateRatio();
  }
  render();

  function handleMinus(e) { e.preventDefault(); e.stopPropagation(); stepperState[id] = parseFloat(Math.max(0, stepperState[id] - step).toFixed(dec)); render(); }
  function handlePlus(e) { e.preventDefault(); e.stopPropagation(); stepperState[id] = parseFloat((stepperState[id] + step).toFixed(dec)); render(); }

  const minusBtn = s.querySelector('.stepper-btn:first-child');
  const plusBtn = s.querySelector('.stepper-btn:last-child');

  // Einfachste zuverl√§ssige L√∂sung: nur click
  // touch-action:manipulation auf dem Button CSS verhindert double-tap zoom
  // und macht click auf iOS genauso zuverl√§ssig wie auf Desktop
  minusBtn.addEventListener('click', handleMinus);
  plusBtn.addEventListener('click', handlePlus);
}

function updateRatio() {
  const d = stepperState['dosis-stepper'] || 0;
  const e = stepperState['espresso-stepper'] || 0;
  if (d > 0) document.getElementById('ratio-chip').textContent = '1 : ' + (e/d).toFixed(1) + ' Ratio';
}

function getStepperVal(id) { return stepperState[id] || 0; }
function setStepperVal(id, val) {
  const s = document.getElementById(id);
  if (!s) return;
  stepperState[id] = val;
  const dec = parseInt(s.dataset.dec);
  const unit = s.dataset.unit;
  const el = s.querySelector('.stepper-value');
  el.innerHTML = (dec > 0 ? val.toFixed(dec) : val) + `<span class="stepper-unit">${unit}</span>`;
  updateRatio();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SAVE SHOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('save-btn').addEventListener('click', async () => {
  const d = getStepperVal('dosis-stepper');
  const e = getStepperVal('espresso-stepper');
  const z = getStepperVal('durchlauf-stepper');
  const ratio = d > 0 ? e / d : 0;
  const shotType = document.querySelector('#bezug-toggle .toggle-btn.active')?.textContent?.trim() || 'Double';
  const basket = document.querySelector('#sieb-toggle .toggle-btn.active')?.textContent?.trim() || 'Bodenlos';
  const puck = !document.getElementById('puck-toggle').classList.contains('off');
  const note = document.getElementById('notes-input').value;

  const newShot = {
    date: new Date(),
    bean: document.getElementById('selected-bean-name').textContent,
    beanSub: document.getElementById('selected-bean-sub').textContent,
    type: shotType, basket, puck, dosis: d, espresso: e,
    ratio: parseFloat(ratio.toFixed(2)), zeit: z, note
  };

  shots.unshift(newShot);
  await dbSaveShot(newShot);

  if (settings.cleaningActive) {
    settings.cleaningCounter = (settings.cleaningCounter || 0) + 1;
    await dbSaveSettings();
    if (settings.cleaningCounter >= settings.cleaningEvery) showCleaningPopup();
  }

  const btn = document.getElementById('save-btn');
  btn.textContent = '‚úì Gespeichert';
  btn.style.background = 'var(--green)';
  setTimeout(() => {
    btn.textContent = 'Shot speichern';
    btn.style.background = '';
    // Standardwerte des aktiven Bezugs wieder setzen
    const activeBezug = document.querySelector('#bezug-toggle .toggle-btn.active')?.textContent?.trim() || 'Double';
    const isDouble = activeBezug === 'Double';
    const defs = isDouble ? (settings.defaultsDouble || {}) : (settings.defaultsSingle || {});
    setStepperVal('dosis-stepper', defs.dosis ?? 18);
    setStepperVal('durchlauf-stepper', defs.zeit ?? 28);
    setStepperVal('espresso-stepper', defs.espresso ?? 36);
    document.getElementById('notes-input').value = '';
  }, 1500);
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILTERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let activeFilters = {};

function matchesFilters(s) {
  const now = new Date();
  if (activeFilters.time) {
    const v = activeFilters.time;
    if (v==='today' && s.date.toDateString() !== now.toDateString()) return false;
    if (v==='week' && ((now-s.date)/86400000 < 0 || (now-s.date)/86400000 > 7)) return false;
    if (v==='kw' && getKW(s.date) !== getKW(now)) return false;
    if (v==='month' && (s.date.getMonth() !== now.getMonth() || s.date.getFullYear() !== now.getFullYear())) return false;
    if (v==='year' && s.date.getFullYear() !== now.getFullYear()) return false;
    if (v==='q1' && s.date.getMonth() > 2) return false;
    if (v==='q2' && (s.date.getMonth() < 3 || s.date.getMonth() > 5)) return false;
    if (v==='q3' && (s.date.getMonth() < 6 || s.date.getMonth() > 8)) return false;
    if (v==='q4' && s.date.getMonth() < 9) return false;
  }
  if (activeFilters.ampel && getAmpel(s.ratio, s.zeit||27) !== activeFilters.ampel) return false;
  if (activeFilters.type && s.type !== activeFilters.type) return false;
  if (activeFilters.basket && s.basket !== activeFilters.basket) return false;
  if (activeFilters.bean && s.bean !== activeFilters.bean) return false;
  if (activeFilters.puck !== undefined && s.puck !== activeFilters.puck) return false;
  return true;
}

function updateFilterBadges() {
  const cnt = Object.keys(activeFilters).length;
  ['verlauf','dash'].forEach(id => {
    const badge = document.getElementById(`filter-badge-${id}`);
    if (badge) { badge.textContent = cnt; badge.classList.toggle('show', cnt > 0); }
  });
}

function buildBeanFilterChips() {
  const group = document.getElementById('bean-filter-group');
  group.innerHTML = beans.map(b => `<div class="opt-chip" data-filter="bean" data-val="${b.name}">${b.emoji} ${b.name}</div>`).join('');
  bindFilterChips();
}

function bindFilterChips() {
  document.querySelectorAll('.opt-chip').forEach(chip => {
    chip.addEventListener('click', () => {
      const grp = chip.dataset.filter;
      document.querySelectorAll(`.opt-chip[data-filter="${grp}"]`).forEach(c => c.classList.remove('active'));
      chip.classList.toggle('active');
    });
  });
}

function openFilterSheet() {
  buildBeanFilterChips();
  document.querySelectorAll('.opt-chip').forEach(c => {
    const val = activeFilters[c.dataset.filter];
    c.classList.toggle('active', val !== undefined && String(val) === c.dataset.val);
  });
  openSheet('filter-overlay');
}

document.getElementById('open-filter-verlauf-btn').addEventListener('click', openFilterSheet);
document.getElementById('open-filter-dash-btn').addEventListener('click', openFilterSheet);

document.getElementById('reset-filters-btn').addEventListener('click', () => {
  document.querySelectorAll('.opt-chip').forEach(c => c.classList.remove('active'));
  activeFilters = {};
  updateFilterBadges();
});

document.getElementById('apply-filter-btn').addEventListener('click', () => {
  activeFilters = {};
  document.querySelectorAll('.opt-chip.active').forEach(c => {
    const k = c.dataset.filter;
    let v = c.dataset.val;
    if (k === 'puck') v = v === 'true';
    activeFilters[k] = v;
  });
  closeSheet('filter-overlay');
  renderVerlauf();
  buildDashboard();
  updateFilterBadges();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SHEET HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openSheet(id) { document.getElementById(id).classList.add('open'); }
function closeSheet(id) { document.getElementById(id).classList.remove('open'); }

document.querySelectorAll('.sheet-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => {
    if (e.target === overlay) overlay.classList.remove('open');
  });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VERLAUF
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentShotDetail = null;

function renderVerlauf() {
  const filtered = shots.filter(matchesFilters);
  const tbody = document.getElementById('shot-table-body');

  if (filtered.length === 0) {
    tbody.innerHTML = `<tr><td colspan="4"><div class="empty-state"><div class="empty-state-icon">‚òï</div><div class="empty-state-text">Keine Shots gefunden</div></div></td></tr>`;
    document.getElementById('stat-total').textContent = '0';
    document.getElementById('stat-avg-ratio').textContent = '‚Äì';
    document.getElementById('stat-green-pct').textContent = '‚Äì';
    document.getElementById('verlauf-sub').textContent = '0 Shots';
    updateActiveChips();
    return;
  }

  tbody.innerHTML = filtered.map((s, idx) => {
    const cls = getAmpel(s.ratio, s.zeit||27);
    return `<tr data-idx="${idx}">
      <td><div class="td-date-day">${fmtDate(s.date)}</div><div class="td-date-sub">${fmtTime(s.date)}</div></td>
      <td><div class="td-bean-name">${s.bean}</div><div class="td-bean-type">${s.type} ¬∑ ${s.beanSub||''}</div></td>
      <td class="td-ratio">1 : ${s.ratio.toFixed(2)}</td>
      <td class="td-ampel"><span class="ampel ${cls}">‚óè</span></td>
    </tr>`;
  }).join('');

  // Click on row ‚Üí Shot Detail
  tbody.querySelectorAll('tr[data-idx]').forEach(row => {
    row.addEventListener('click', () => {
      const idx = parseInt(row.dataset.idx);
      openShotDetail(filtered[idx]);
    });
  });

  const total = filtered.length;
  const avg = filtered.reduce((a,s) => a+s.ratio, 0) / total;
  const greenCt = filtered.filter(s => getAmpel(s.ratio, s.zeit||27) === 'green').length;
  document.getElementById('stat-total').textContent = total;
  document.getElementById('stat-avg-ratio').textContent = '1:' + avg.toFixed(1);
  document.getElementById('stat-green-pct').textContent = Math.round(greenCt/total*100) + '%';
  document.getElementById('verlauf-sub').textContent = `${total} Shot${total!==1?'s':''}`;
  updateActiveChips();
  updateFilterBadges();
}

// ‚îÄ‚îÄ Shot Detail ‚îÄ‚îÄ
function openShotDetail(shot) {
  currentShotDetail = shot;
  const cls = getAmpel(shot.ratio, shot.zeit||27);
  const labels = { green: 'üü¢ Gr√ºner Shot', yellow: 'üü° Gelber Shot', red: 'üî¥ Roter Shot' };

  document.getElementById('shot-detail-title').textContent = `${shot.bean} ¬∑ ${fmtDate(shot.date)}`;
  document.getElementById('shot-detail-ampel').className = `ampel ${cls}`;
  document.getElementById('shot-detail-ampel-label').textContent = labels[cls];

  document.getElementById('sd-dosis').innerHTML = `${shot.dosis}<span class="shot-detail-unit">g</span>`;
  document.getElementById('sd-espresso').innerHTML = `${shot.espresso}<span class="shot-detail-unit">g</span>`;
  document.getElementById('sd-ratio').textContent = `1 : ${shot.ratio.toFixed(2)}`;
  document.getElementById('sd-zeit').innerHTML = `${shot.zeit||'‚Äì'}<span class="shot-detail-unit">s</span>`;
  document.getElementById('sd-type').textContent = shot.type;
  document.getElementById('sd-basket').textContent = shot.basket;
  document.getElementById('sd-puck').textContent = shot.puck ? '‚úì Verwendet' : '‚úó Nicht verwendet';

  const noteWrap = document.getElementById('sd-note-wrap');
  if (shot.note && shot.note.trim()) {
    document.getElementById('sd-note').textContent = shot.note;
    noteWrap.style.display = '';
  } else {
    noteWrap.style.display = 'none';
  }

  openSheet('shot-detail-overlay');
}

document.getElementById('delete-shot-btn').addEventListener('click', async () => {
  if (!currentShotDetail) return;
  const idx = shots.indexOf(currentShotDetail);
  if (idx !== -1) {
    const removed = shots.splice(idx, 1)[0];
    await dbDeleteShot(removed.id);
    closeSheet('shot-detail-overlay');
    renderVerlauf();
    buildDashboard();
  }
});

function updateActiveChips() {
  const bar = document.getElementById('active-filter-chips');
  const labels = {
    time:{today:'Heute',week:'Diese Woche',kw:'Akt. KW',month:'Dieser Monat',q1:'Q1',q2:'Q2',q3:'Q3',q4:'Q4',year:'Dieses Jahr'},
    ampel:{green:'üü¢ Gr√ºn',yellow:'üü° Gelb',red:'üî¥ Rot'},
    type:v=>v, basket:v=>v, bean:v=>v,
    puck:{true:'Puck ‚úì',false:'Puck ‚úó'}
  };
  const chips = Object.entries(activeFilters).map(([k,v]) => {
    const lbl = typeof labels[k]==='function' ? labels[k](v) : (labels[k]?.[v]||v);
    return `<span class="filter-chip active" data-remove="${k}">${lbl} ‚úï</span>`;
  });
  bar.innerHTML = chips.length > 0 ? chips.join('') : '<span style="font-size:12px;color:var(--text-secondary);align-self:center;white-space:nowrap;">Alle Shots</span>';
  bar.querySelectorAll('.filter-chip[data-remove]').forEach(c => {
    c.addEventListener('click', () => {
      delete activeFilters[c.dataset.remove];
      renderVerlauf();
      buildDashboard();
      updateFilterBadges();
    });
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildDashboard() {
  const el = document.getElementById('dash-content');
  const filtered = shots.filter(matchesFilters);
  el.innerHTML = '';

  if (filtered.length === 0) {
    el.innerHTML = `<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:16px;padding:40px 0;">
      <div style="font-size:48px;opacity:0.3;">‚òï</div>
      <div style="font-size:18px;font-weight:600;color:var(--text-primary);text-align:center;">Noch keine Shots</div>
      <div style="font-size:13px;color:var(--text-secondary);text-align:center;">Logge deinen ersten Espresso Shot!</div>
      <button onclick="showScreen('screen-log')" style="background:var(--text-primary);color:white;border:none;border-radius:16px;padding:14px 24px;font-family:-apple-system,'Helvetica Neue',Arial,sans-serif;font-size:14px;font-weight:600;cursor:pointer;">Zum Shot Log ‚Üí</button>
    </div>`;
    return;
  }

  const total = filtered.length;
  const avgRatio = filtered.reduce((a,s) => a+s.ratio, 0) / total;
  const green = filtered.filter(s => getAmpel(s.ratio, s.zeit||27) === 'green').length;

  el.innerHTML += `<div class="kpi-row">
    <div class="kpi-card"><div class="kpi-value">${total}</div><div class="kpi-label">Shots</div><div class="kpi-delta neutral">gesamt</div></div>
    <div class="kpi-card"><div class="kpi-value">${Math.round(green/total*100)}%</div><div class="kpi-label">üü¢ Quote</div></div>
    <div class="kpi-card"><div class="kpi-value">1:${avgRatio.toFixed(1)}</div><div class="kpi-label">√ò Ratio</div></div>
  </div>`;

  const insights = generateInsights(filtered);
  if (insights.length > 0) {
    el.innerHTML += `<div class="dash-section"><div class="dash-section-title">Insights</div>
    ${insights.map(i => `<div class="insight-card ${i.type}"><div class="insight-icon">${i.icon}</div><div><div class="insight-title">${i.title}</div><div class="insight-text">${i.text}</div></div></div>`).join('')}
    </div>`;
  }

  const gCnt = filtered.filter(s => getAmpel(s.ratio,s.zeit||27)==='green').length;
  const yCnt = filtered.filter(s => getAmpel(s.ratio,s.zeit||27)==='yellow').length;
  const rCnt = filtered.filter(s => getAmpel(s.ratio,s.zeit||27)==='red').length;
  const R=44,cx=56,cy=56,circ=2*Math.PI*R;
  const gD=(gCnt/total)*circ, yD=(yCnt/total)*circ, rD=(rCnt/total)*circ;
  el.innerHTML += `<div class="dash-section"><div class="dash-section-title">Qualit√§t</div>
  <div class="chart-card"><div class="chart-title">Ampel-Verteilung</div>
  <div class="donut-row">
    <svg width="112" height="112" viewBox="0 0 112 112">
      <circle cx="${cx}" cy="${cy}" r="${R}" fill="none" stroke="var(--bg)" stroke-width="16"/>
      <circle cx="${cx}" cy="${cy}" r="${R}" fill="none" stroke="var(--green)" stroke-width="16" stroke-dasharray="${gD} ${circ-gD}" stroke-dashoffset="0" transform="rotate(-90 ${cx} ${cy})"/>
      <circle cx="${cx}" cy="${cy}" r="${R}" fill="none" stroke="var(--yellow)" stroke-width="16" stroke-dasharray="${yD} ${circ-yD}" stroke-dashoffset="${-gD}" transform="rotate(-90 ${cx} ${cy})"/>
      <circle cx="${cx}" cy="${cy}" r="${R}" fill="none" stroke="var(--red)" stroke-width="16" stroke-dasharray="${rD} ${circ-rD}" stroke-dashoffset="${-(gD+yD)}" transform="rotate(-90 ${cx} ${cy})"/>
      <text x="${cx}" y="${cy-5}" text-anchor="middle" font-family="-apple-system, Helvetica Neue, Arial, sans-serif" font-size="18" font-weight="700" fill="var(--text-primary)">${Math.round(gCnt/total*100)}%</text>
      <text x="${cx}" y="${cy+10}" text-anchor="middle" font-family="-apple-system, Helvetica Neue, Arial, sans-serif" font-size="10" fill="var(--text-secondary)">gr√ºn</text>
    </svg>
    <div class="donut-legend">
      <div class="donut-legend-item"><div class="donut-legend-dot" style="background:var(--green)"></div><span class="donut-legend-label">Gr√ºn</span><span class="donut-legend-val">${gCnt} (${Math.round(gCnt/total*100)}%)</span></div>
      <div class="donut-legend-item"><div class="donut-legend-dot" style="background:var(--yellow)"></div><span class="donut-legend-label">Gelb</span><span class="donut-legend-val">${yCnt} (${Math.round(yCnt/total*100)}%)</span></div>
      <div class="donut-legend-item"><div class="donut-legend-dot" style="background:var(--red)"></div><span class="donut-legend-label">Rot</span><span class="donut-legend-val">${rCnt} (${Math.round(rCnt/total*100)}%)</span></div>
    </div>
  </div></div></div>`;

  const beanNames = [...new Set(filtered.map(s => s.bean))];
  const beanStats = beanNames.map(name => {
    const bs = filtered.filter(s => s.bean === name);
    const avgR = bs.reduce((a,s) => a+s.ratio, 0) / bs.length;
    const greenQ = Math.round(bs.filter(s => getAmpel(s.ratio,s.zeit||27)==='green').length / bs.length * 100);
    const bObj = beans.find(b => b.name === name);
    return { name, cnt: bs.length, avgR, greenQ, totalGrams: bObj?.totalGrams || 0 };
  });

  el.innerHTML += `<div class="dash-section"><div class="dash-section-title">Bohnen</div>
  <div class="chart-card"><div class="chart-title">üü¢ Quote pro Bohne</div>
  ${beanStats.map(b => `<div class="compare-row">
    <div class="compare-label" style="font-size:10px">${b.name}</div>
    <div class="compare-track"><div class="compare-fill" style="width:${Math.max(b.greenQ,5)}%;background:var(--accent)"><span class="compare-fill-val">${b.greenQ}%</span></div></div>
    <div style="font-size:10px;color:var(--text-secondary);width:24px">${b.cnt}√ó</div>
  </div>`).join('')}
  </div>
  <div class="chart-card"><div class="chart-title">Verbrauch (eingef√ºllt)</div>
  ${beanStats.map(b => {
    const kg = b.totalGrams >= 1000 ? (b.totalGrams/1000).toFixed(1)+'kg' : b.totalGrams+'g';
    const pct = Math.min(Math.round((b.totalGrams/2000)*100), 100);
    return `<div class="compare-row">
      <div class="compare-label" style="font-size:10px">${b.name}</div>
      <div class="compare-track"><div class="compare-fill" style="width:${Math.max(pct,8)}%;background:var(--accent-light)"><span style="font-size:10px;font-weight:700;color:var(--accent)">${kg}</span></div></div>
    </div>`;
  }).join('')}
  </div></div>`;

  const byDay = [0,0,0,0,0,0,0];
  filtered.forEach(s => byDay[s.date.getDay()]++);
  const maxDay = Math.max(...byDay, 1);
  const bW=30, bH=55, bG=11;
  el.innerHTML += `<div class="dash-section"><div class="dash-section-title">Muster</div>
  <div class="chart-card"><div class="chart-title">Shots nach Wochentag</div>
  <svg class="chart-svg" height="${bH+26}" viewBox="0 0 ${7*(bW+bG)-bG} ${bH+26}">
    ${byDay.map((cnt,i) => {
      const h = cnt>0?(cnt/maxDay)*bH:2;
      const x = i*(bW+bG), y = bH-h;
      const col = i===0||i===6?'var(--accent-light)':'var(--accent)';
      return `<rect x="${x}" y="${y}" width="${bW}" height="${h}" rx="5" fill="${col}"/>
      <text x="${x+bW/2}" y="${bH+12}" text-anchor="middle" class="chart-label">${DAYS[i]}</text>
      ${cnt>0?`<text x="${x+bW/2}" y="${y-4}" text-anchor="middle" class="chart-val">${cnt}</text>`:''}`;
    }).join('')}
  </svg></div></div>`;
}

function generateInsights(filtered) {
  if (!filtered || filtered.length === 0) return [];
  const insights = [];
  const beanNames = [...new Set(filtered.map(s => s.bean))];
  beanNames.forEach(name => {
    const bs = filtered.filter(s => s.bean === name);
    if (bs.length < 2) return;
    const redShots = bs.filter(s => getAmpel(s.ratio,s.zeit||27)==='red');
    const avgZ = bs.reduce((a,s) => a+(s.zeit||27), 0) / bs.length;
    if (redShots.length >= 2) {
      const avgR = bs.reduce((a,s) => a+s.ratio, 0) / bs.length;
      insights.push({type:'warn',icon:'‚ö†Ô∏è',title:`${name}: Oft au√üerhalb`,text:`${redShots.length}/${bs.length} Shots rot. √ò 1:${avgR.toFixed(1)}`});
    }
    if (avgZ < settings.ampel.zeitGMin && bs.length >= 2)
      insights.push({type:'tip',icon:'üîß',title:`${name}: Durchlauf zu kurz`,text:`√ò ${avgZ.toFixed(0)}s ‚Äî Mahlgrad feiner.`});
    if (avgZ > settings.ampel.zeitGMax && bs.length >= 2)
      insights.push({type:'tip',icon:'üîß',title:`${name}: Durchlauf zu lang`,text:`√ò ${avgZ.toFixed(0)}s ‚Äî Mahlgrad grober.`});
  });
  if (filtered.length >= 6) {
    const r = filtered.slice(0,5), o = filtered.slice(5);
    const rG = r.filter(s=>getAmpel(s.ratio,s.zeit||27)==='green').length/r.length;
    const oG = o.filter(s=>getAmpel(s.ratio,s.zeit||27)==='green').length/o.length;
    const diff = Math.round((rG-oG)*100);
    if (diff >= 10) insights.push({type:'good',icon:'üìà',title:'Du wirst besser!',text:`Letzte 5: ${Math.round(rG*100)}% gr√ºn (+${diff}%)`});
    if (diff <= -10) insights.push({type:'warn',icon:'üìâ',title:'Qualit√§t gesunken',text:`Letzte 5: ${Math.round(rG*100)}% gr√ºn (${diff}%)`});
  }
  return insights.slice(0,4);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BEANS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let pendingDetailBeanId = null;
let tempSelectedBeanId = null;
let fillTargetBeanId = null;
const SLOTS = 3;

function renderBeans() {
  const list = document.getElementById('bean-list');
  const slots = [...beans];
  while (slots.length < SLOTS) slots.push(null);
  tempSelectedBeanId = selectedBeanId;

  list.innerHTML = slots.map((b) => {
    if (!b) return `<div class="bean-slot empty"><span class="bean-slot-empty-text">Leer</span></div>`;
    const stars = b.stars > 0 ? '‚òÖ'.repeat(b.stars)+'‚òÜ'.repeat(5-b.stars) : '‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ';
    const isSel = b.id === tempSelectedBeanId;
    return `<div class="bean-slot filled ${isSel?'selected':''}" data-id="${b.id}">
      <div class="bean-dot">${b.emoji}</div>
      <div class="bean-item-info">
        <div class="bean-item-name">${b.name}</div>
        <div class="bean-item-sub">${b.sub}</div>
        <div class="bean-item-stars">${stars}</div>
      </div>
      <button class="bean-select-btn ${isSel?'selected':''}" data-select="${b.id}">‚úì</button>
    </div>`;
  }).join('');

  list.querySelectorAll('.bean-slot.filled').forEach(slot => {
    slot.addEventListener('click', e => {
      if (e.target.closest('.bean-select-btn')) return;
      pendingDetailBeanId = parseInt(slot.dataset.id);
      openBeanDetail(pendingDetailBeanId);
      openSheet('bean-detail-overlay');
    });
  });

  list.querySelectorAll('.bean-select-btn').forEach(btn => {
    btn.addEventListener('click', e => {
      e.stopPropagation();
      tempSelectedBeanId = parseInt(btn.dataset.select);
      list.querySelectorAll('.bean-slot.filled').forEach(s => {
        const id = parseInt(s.dataset.id);
        s.classList.toggle('selected', id === tempSelectedBeanId);
        const sb = s.querySelector('.bean-select-btn');
        if (sb) sb.classList.toggle('selected', id === tempSelectedBeanId);
      });
    });
  });
}

document.getElementById('confirm-bean-selection-btn').addEventListener('click', async () => {
  if (tempSelectedBeanId !== null) {
    selectedBeanId = tempSelectedBeanId;
    saveLocal('espresso_selected_bean_v2', String(selectedBeanId));
    await dbSaveSettings();
    const b = beans.find(x => String(x.id) === String(selectedBeanId));
    if (b) {
      document.getElementById('selected-bean-name').textContent = b.name;
      document.getElementById('selected-bean-sub').textContent = b.sub || '';
    }
  }
  closeSheet('bean-sheet-overlay');
});

document.getElementById('open-sheet-btn').addEventListener('click', () => {
  renderBeans();
  openSheet('bean-sheet-overlay');
});

document.getElementById('btn-fill-bean').addEventListener('click', () => {
  renderFillBeanList();
  openSheet('fill-select-overlay');
});

function renderFillBeanList() {
  const list = document.getElementById('fill-bean-list');
  if (beans.length === 0) {
    list.innerHTML = '<div class="empty-state"><div class="empty-state-text">Keine Bohnen gespeichert</div></div>';
    return;
  }
  list.innerHTML = beans.map(b => `
    <div class="bean-slot filled" data-id="${b.id}" style="cursor:pointer;">
      <div class="bean-dot">${b.emoji}</div>
      <div class="bean-item-info">
        <div class="bean-item-name">${b.name}</div>
        <div class="bean-item-sub">${b.sub}</div>
      </div>
      <span style="font-size:12px;color:var(--accent);font-weight:600;">W√§hlen ‚Üí</span>
    </div>`).join('');
  list.querySelectorAll('.bean-slot.filled').forEach(slot => {
    slot.addEventListener('click', () => {
      fillTargetBeanId = parseInt(slot.dataset.id);
      const b = beans.find(x => x.id === fillTargetBeanId);
      document.getElementById('gram-sheet-title').textContent = `${b?.name} auff√ºllen`;
      document.querySelectorAll('.gram-btn').forEach(gb => gb.classList.remove('active'));
      closeSheet('fill-select-overlay');
      openSheet('gram-sheet-overlay');
    });
  });
}

document.getElementById('btn-new-bean').addEventListener('click', () => {
  document.getElementById('new-bean-name').value = '';
  document.getElementById('new-bean-sub').value = '';
  document.getElementById('new-bean-emoji').value = 'ü´ò';
  document.querySelectorAll('.new-gram-btn').forEach(b => b.classList.remove('active'));
  openSheet('new-bean-overlay');
});

document.querySelectorAll('.new-gram-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.new-gram-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  });
});

document.getElementById('confirm-new-bean-btn').addEventListener('click', async () => {
  const name = document.getElementById('new-bean-name').value.trim();
  if (!name) return;
  const activeGram = document.querySelector('.new-gram-btn.active');
  const grams = activeGram ? parseInt(activeGram.dataset.gram) : 0;
  const newId = Date.now();
  const newBean = { id: newId, name, sub: document.getElementById('new-bean-sub').value.trim() || '', emoji: document.getElementById('new-bean-emoji').value.trim() || 'ü´ò', stars: 0, totalGrams: grams };
  beans.push(newBean);
  await dbSaveBean(newBean);
  selectedBeanId = newId;
  await dbSaveSettings();
  document.getElementById('selected-bean-name').textContent = newBean.name;
  document.getElementById('selected-bean-sub').textContent = newBean.sub;
  closeSheet('new-bean-overlay');
  closeSheet('bean-sheet-overlay');
});

document.querySelectorAll('.gram-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    if (btn.classList.contains('new-gram-btn')) return;
    document.querySelectorAll('.gram-btn:not(.new-gram-btn)').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  });
});

document.getElementById('confirm-gram-btn').addEventListener('click', async () => {
  const activeGram = document.querySelector('#gram-sheet-overlay .gram-btn.active');
  if (!activeGram) return;
  const grams = parseInt(activeGram.dataset.gram);
  if (fillTargetBeanId) {
    const bean = beans.find(b => b.id === fillTargetBeanId);
    if (bean) { bean.totalGrams = (bean.totalGrams||0) + grams; await dbSaveBean(bean); }
    fillTargetBeanId = null;
  }
  closeSheet('gram-sheet-overlay');
  renderBeans();
});

function openBeanDetail(beanId) {
  const bean = beans.find(b => b.id === beanId);
  if (!bean) return;
  document.getElementById('bean-detail-title').textContent = bean.name;
  document.querySelectorAll('.star-btn').forEach(s => {
    s.classList.toggle('active', parseInt(s.dataset.star) <= (bean.stars||0));
  });
}

document.querySelectorAll('.star-btn').forEach(star => {
  star.addEventListener('click', () => {
    const n = parseInt(star.dataset.star);
    document.querySelectorAll('.star-btn').forEach(s => s.classList.toggle('active', parseInt(s.dataset.star) <= n));
  });
});

document.getElementById('save-star-btn').addEventListener('click', async () => {
  const rating = document.querySelectorAll('.star-btn.active').length;
  const bean = beans.find(b => b.id === pendingDetailBeanId);
  if (bean) { bean.stars = rating; await dbSaveBean(bean); }
  closeSheet('bean-detail-overlay');
  renderBeans();
});

document.getElementById('delete-bean-btn').addEventListener('click', async () => {
  const beanId = pendingDetailBeanId;
  beans = beans.filter(b => b.id !== beanId);
  await dbDeleteBean(beanId);
  if (selectedBeanId === beanId) {
    selectedBeanId = beans.length > 0 ? beans[0].id : null;
    await dbSaveSettings();
    const b = beans.find(x => x.id === selectedBeanId);
    document.getElementById('selected-bean-name').textContent = b?.name || '‚Äì';
    document.getElementById('selected-bean-sub').textContent = b?.sub || '';
  }
  closeSheet('bean-detail-overlay');
  renderBeans();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('settings-btn').addEventListener('click', () => {
  // Username und Device-ID beim √ñffnen frisch laden
  const deviceDisplay = document.getElementById('device-id-display');
  if (deviceDisplay) deviceDisplay.textContent = DEVICE_ID;
  const savedUsername = localStorage.getItem('espresso_username');
  const unInput = document.getElementById('setting-username');
  if (unInput && savedUsername) unInput.value = savedUsername;
  if (unInput && !savedUsername) unInput.value = '';
  loadSettingsIntoUI();
  openSheet('settings-overlay');
});

function loadSettingsIntoUI() {
  document.getElementById('setting-machine').value = settings.machine || '';
  document.getElementById('setting-grinder').value = settings.grinder || '';
  document.getElementById('setting-autotimer').classList.toggle('off', !settings.autoTimer);
  document.getElementById('setting-cleaning-active').classList.toggle('off', !settings.cleaningActive);
  document.getElementById('cleaning-val').textContent = settings.cleaningEvery;
  const ds = settings.defaultsSingle || {};
  const dd = settings.defaultsDouble || {};
  document.getElementById('setting-default-dosis-single').value = ds.dosis ?? 14;
  document.getElementById('setting-default-zeit-single').value = ds.zeit ?? 25;
  document.getElementById('setting-default-espresso-single').value = ds.espresso ?? 25;
  document.getElementById('setting-default-dosis-double').value = dd.dosis ?? 18;
  document.getElementById('setting-default-zeit-double').value = dd.zeit ?? 28;
  document.getElementById('setting-default-espresso-double').value = dd.espresso ?? 36;
  const a = settings.ampel;
  document.getElementById('amp-ratio-g-min').value = a.ratioGMin;
  document.getElementById('amp-ratio-g-max').value = a.ratioGMax;
  document.getElementById('amp-zeit-g-min').value = a.zeitGMin;
  document.getElementById('amp-zeit-g-max').value = a.zeitGMax;
  document.getElementById('amp-ratio-y-min').value = a.ratioYMin;
  document.getElementById('amp-ratio-y-max').value = a.ratioYMax;
  document.getElementById('amp-zeit-y-min').value = a.zeitYMin;
  document.getElementById('amp-zeit-y-max').value = a.zeitYMax;
  document.getElementById('unit-g-btn').classList.toggle('active', settings.unit !== 'ml');
  document.getElementById('unit-ml-btn').classList.toggle('active', settings.unit === 'ml');
  updateCleaningCounterSub();
}

async function saveSettingsFromUI() {
  settings.machine = document.getElementById('setting-machine').value;
  settings.grinder = document.getElementById('setting-grinder').value;
  settings.autoTimer = !document.getElementById('setting-autotimer').classList.contains('off');
  settings.cleaningActive = !document.getElementById('setting-cleaning-active').classList.contains('off');
  settings.defaultsSingle = {
    dosis: parseFloat(document.getElementById('setting-default-dosis-single').value) || 14,
    zeit: parseFloat(document.getElementById('setting-default-zeit-single').value) || 25,
    espresso: parseFloat(document.getElementById('setting-default-espresso-single').value) || 25,
  };
  settings.defaultsDouble = {
    dosis: parseFloat(document.getElementById('setting-default-dosis-double').value) || 18,
    zeit: parseFloat(document.getElementById('setting-default-zeit-double').value) || 28,
    espresso: parseFloat(document.getElementById('setting-default-espresso-double').value) || 36,
  };
  await dbSaveSettings();
  // Device-ID und Username in Einstellungen anzeigen
  const deviceDisplay = document.getElementById('device-id-display');
  if (deviceDisplay) deviceDisplay.textContent = DEVICE_ID;
  const savedUsername = localStorage.getItem('espresso_username');
  if (savedUsername) {
    const unInput = document.getElementById('setting-username');
    if (unInput) unInput.value = savedUsername;
  }

  const badge = document.getElementById('timer-mode-badge');
  badge.textContent = settings.autoTimer ? 'AUTO' : 'MANUELL';
  badge.className = 'auto-badge ' + (settings.autoTimer ? 'auto' : 'manual');
  if (settings.autoTimer) initAutoTimer(); else stopAutoTimer();
}

document.getElementById('settings-overlay').addEventListener('click', e => {
  if (e.target === document.getElementById('settings-overlay')) {
    saveSettingsFromUI();
    closeSheet('settings-overlay');
  }
});

document.getElementById('defaults-single-btn').addEventListener('click', () => {
  document.getElementById('defaults-single-btn').classList.add('active');
  document.getElementById('defaults-double-btn').classList.remove('active');
  document.getElementById('defaults-single').style.display = '';
  document.getElementById('defaults-double').style.display = 'none';
});
document.getElementById('defaults-double-btn').addEventListener('click', () => {
  document.getElementById('defaults-double-btn').classList.add('active');
  document.getElementById('defaults-single-btn').classList.remove('active');
  document.getElementById('defaults-single').style.display = 'none';
  document.getElementById('defaults-double').style.display = '';
});

document.getElementById('setting-autotimer').addEventListener('click', function() { this.classList.toggle('off'); });
document.getElementById('setting-cleaning-active').addEventListener('click', function() { this.classList.toggle('off'); updateCleaningCounterSub(); });

function updateCleaningCounterSub() {
  const active = !document.getElementById('setting-cleaning-active').classList.contains('off');
  document.getElementById('cleaning-counter-sub').textContent = active
    ? `${settings.cleaningCounter} von ${settings.cleaningEvery} Bez√ºgen`
    : 'Deaktiviert';
}

document.getElementById('cleaning-minus').addEventListener('click', async () => {
  settings.cleaningEvery = Math.max(5, settings.cleaningEvery - 5);
  document.getElementById('cleaning-val').textContent = settings.cleaningEvery;
  await dbSaveSettings(); updateCleaningCounterSub();
});
document.getElementById('cleaning-plus').addEventListener('click', async () => {
  settings.cleaningEvery += 5;
  document.getElementById('cleaning-val').textContent = settings.cleaningEvery;
  await dbSaveSettings(); updateCleaningCounterSub();
});

document.getElementById('save-ampel-btn').addEventListener('click', async () => {
  settings.ampel = {
    ratioGMin: parseFloat(document.getElementById('amp-ratio-g-min').value),
    ratioGMax: parseFloat(document.getElementById('amp-ratio-g-max').value),
    zeitGMin: parseFloat(document.getElementById('amp-zeit-g-min').value),
    zeitGMax: parseFloat(document.getElementById('amp-zeit-g-max').value),
    ratioYMin: parseFloat(document.getElementById('amp-ratio-y-min').value),
    ratioYMax: parseFloat(document.getElementById('amp-ratio-y-max').value),
    zeitYMin: parseFloat(document.getElementById('amp-zeit-y-min').value),
    zeitYMax: parseFloat(document.getElementById('amp-zeit-y-max').value),
  };
  await dbSaveSettings();
  const btn = document.getElementById('save-ampel-btn');
  const origText = btn.textContent;
  const origBg = btn.style.background;
  btn.textContent = '‚úì Gespeichert';
  btn.style.background = 'var(--green)';
  btn.style.opacity = '1';
  setTimeout(() => {
    btn.textContent = origText;
    btn.style.background = origBg;
  }, 1800);
});

// Username Button
document.getElementById('save-username-btn').addEventListener('click', async () => {
  const username = document.getElementById('setting-username').value;
  if (!username.trim()) {
    document.getElementById('username-status').textContent = 'Bitte Benutzernamen eingeben';
    document.getElementById('username-status').style.color = 'var(--red)';
    return;
  }
  const btn = document.getElementById('save-username-btn');
  btn.textContent = '‚è≥ Wird gespeichert...';
  await saveUsername(username);
  btn.textContent = 'Benutzername speichern';
});

document.getElementById('unit-g-btn').addEventListener('click', async () => {
  settings.unit = 'g'; await dbSaveSettings();
  document.getElementById('unit-g-btn').classList.add('active');
  document.getElementById('unit-ml-btn').classList.remove('active');
});
document.getElementById('unit-ml-btn').addEventListener('click', async () => {
  settings.unit = 'ml'; await dbSaveSettings();
  document.getElementById('unit-ml-btn').classList.add('active');
  document.getElementById('unit-g-btn').classList.remove('active');
});

// CSV Export
document.getElementById('export-csv-btn').addEventListener('click', () => {
  if (shots.length === 0) { alert('Keine Shots zum Exportieren.'); return; }
  const header = 'Datum,Uhrzeit,Bohne,BohneDetail,Typ,Siebtraeger,Dosis_g,Espresso_g,Ratio,Zeit_s,Puck,Notiz,Ampel\n';
  const rows = shots.map(s => [
    `"${fmtDate(s.date)}"`, `"${fmtTime(s.date)}"`, `"${(s.bean||'').replace(/"/g,"'")}"`, `"${(s.beanSub||'').replace(/"/g,"'")}"`,
    `"${s.type||''}"`, `"${s.basket||''}"`, s.dosis, s.espresso, s.ratio, s.zeit||'',
    s.puck?'Ja':'Nein', `"${(s.note||'').replace(/"/g,"'")}"`, getAmpel(s.ratio, s.zeit||27)
  ].join(',')).join('\n');
  const blob = new Blob([header+rows], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'espresso-shots.csv'; a.click();
  URL.revokeObjectURL(url);
});

document.getElementById('import-csv-btn').addEventListener('click', () => {
  document.getElementById('import-file-input').click();
});

document.getElementById('import-file-input').addEventListener('change', async e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async ev => {
    const lines = ev.target.result.split('\n').filter(l => l.trim());
    if (lines.length < 2) { alert('Keine Daten gefunden.'); return; }
    // Robuster CSV Parser: quoted fields mit Kommas korrekt behandeln
    function parseCSVLine(line) {
      const result = []; let cur = ''; let inQuote = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') { inQuote = !inQuote; }
        else if (ch === ',' && !inQuote) { result.push(cur.trim()); cur = ''; }
        else { cur += ch; }
      }
      result.push(cur.trim());
      return result;
    }
    const headers = parseCSVLine(lines[0]);
    let imported = 0;
    for (let i = 1; i < lines.length; i++) {
      try {
        const cols = parseCSVLine(lines[i]);
        const row = {};
        headers.forEach((h, idx) => { row[h.trim()] = (cols[idx] || '').trim(); });
        const dosis = parseFloat(row['Dosis_g']);
        const espresso = parseFloat(row['Espresso_g']);
        const ratio = parseFloat(row['Ratio']);
        const zeit = parseFloat(row['Zeit_s']) || 27;
        if (isNaN(dosis) && isNaN(ratio)) continue;
        const newShot = {
          date: new Date(),
          bean: row['Bohne'] || '',
          beanSub: row['BohneDetail'] || '',
          type: row['Typ'] || 'Double',
          basket: row['Siebtraeger'] || 'Bodenlos',
          dosis: isNaN(dosis) ? 0 : dosis,
          espresso: isNaN(espresso) ? 0 : espresso,
          ratio: isNaN(ratio) ? 0 : ratio,
          zeit, puck: row['Puck'] === 'Ja',
          note: row['Notiz'] || ''
        };
        shots.push(newShot);
        await dbSaveShot(newShot);
        imported++;
      } catch(err) {}
    }
    e.target.value = '';
    alert(`${imported} Shots importiert.`);
  };
  reader.readAsText(file);
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLEANING POPUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showCleaningPopup() {
  document.getElementById('cleaning-popup-text').textContent =
    `Du hast ${settings.cleaningCounter} Bez√ºge gemacht. Zeit f√ºr eine Reinigung!`;
  document.getElementById('cleaning-popup').classList.add('open');
}
document.getElementById('cleaning-later-btn').addEventListener('click', () => {
  document.getElementById('cleaning-popup').classList.remove('open');
});
document.getElementById('cleaning-done-btn').addEventListener('click', async () => {
  settings.cleaningCounter = 0;
  await dbSaveSettings();
  document.getElementById('cleaning-popup').classList.remove('open');
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTO TIMER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let audioCtx = null, analyser = null, micStream = null, timerInterval = null;
let timerRunning = false, timerSeconds = 0, lastPeakTime = 0;

async function initAutoTimer() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    micStream = stream;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const source = audioCtx.createMediaStreamSource(stream);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;
    source.connect(analyser);
    monitorAudio();
  } catch(e) {
    settings.autoTimer = false; await dbSaveSettings();
    document.getElementById('timer-mode-badge').textContent = 'MANUELL';
    document.getElementById('timer-mode-badge').className = 'auto-badge manual';
  }
}

function stopAutoTimer() {
  if (micStream) { micStream.getTracks().forEach(t => t.stop()); micStream = null; }
  if (audioCtx) { audioCtx.close(); audioCtx = null; analyser = null; }
  if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
  timerRunning = false;
}

function monitorAudio() {
  if (!analyser) return;
  const data = new Uint8Array(analyser.frequencyBinCount);
  function check() {
    if (!analyser) return;
    analyser.getByteFrequencyData(data);
    const avg = data.reduce((a,b) => a+b, 0) / data.length;
    const now = Date.now();
    if (avg > 60 && (now - lastPeakTime) > 1500) {
      lastPeakTime = now;
      if (!timerRunning) {
        timerRunning = true; timerSeconds = 0;
        timerInterval = setInterval(() => { timerSeconds++; setStepperVal('durchlauf-stepper', timerSeconds); }, 1000);
      } else {
        clearInterval(timerInterval); timerInterval = null; timerRunning = false;
      }
    }
    requestAnimationFrame(check);
  }
  check();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATE / TIME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateDateTime() {
  const now = new Date();
  document.getElementById('current-date').textContent = `${fmtDate(now)} ¬∑ ${fmtTime(now)}`;
}
setInterval(updateDateTime, 30000);
document.getElementById('kw-label').textContent = getKW(new Date());

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SOFORT: Bean aus localStorage anzeigen (synchron, vor Supabase)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function restoreBeanUI() {
  const beanId = selectedBeanId !== null && selectedBeanId !== undefined
    ? selectedBeanId
    : loadLocal('espresso_selected_bean_v2', null);
  if (!beanId) return;
  // Erst aus bereits geladenen beans[] suchen, dann aus localStorage-Cache
  const searchIn = beans.length > 0 ? beans : loadLocal('espresso_beans_v2', []);
  const b = searchIn.find(x => String(x.id) === String(beanId));
  if (b) {
    selectedBeanId = b.id;
    const nameEl = document.getElementById('selected-bean-name');
    const subEl = document.getElementById('selected-bean-sub');
    if (nameEl) nameEl.textContent = b.name || '‚Äì';
    if (subEl) subEl.textContent = b.sub || '';
    saveLocal('espresso_selected_bean_v2', String(b.id));
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function initApp() {
  updateDateTime();

  // Sofort Bean aus localStorage anzeigen (synchron)
  restoreBeanUI();

  // Load from Supabase (falls back to localStorage if offline)
  await dbLoadAll();

  const activeBezug = document.querySelector('#bezug-toggle .toggle-btn.active')?.textContent?.trim() || 'Double';
  const isDouble = activeBezug === 'Double';
  const defs = isDouble ? (settings.defaultsDouble||{}) : (settings.defaultsSingle||{});

  initStepper('dosis-stepper', defs.dosis ?? 18);
  initStepper('durchlauf-stepper', defs.zeit ?? 28);
  initStepper('espresso-stepper', defs.espresso ?? 36);

  // Bohne mit frischen Supabase-Daten aktualisieren
  restoreBeanUI();

  // Device-ID und Username in Einstellungen anzeigen
  const deviceDisplay = document.getElementById('device-id-display');
  if (deviceDisplay) deviceDisplay.textContent = DEVICE_ID;
  const savedUsername = localStorage.getItem('espresso_username');
  if (savedUsername) {
    const unInput = document.getElementById('setting-username');
    if (unInput) unInput.value = savedUsername;
  }

  const badge = document.getElementById('timer-mode-badge');
  badge.textContent = settings.autoTimer ? 'AUTO' : 'MANUELL';
  badge.className = 'auto-badge ' + (settings.autoTimer ? 'auto' : 'manual');
  if (settings.autoTimer) initAutoTimer();

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(() => {});
  }
}
</script>

</body>
</html>
